import{r as l,j as e,B as S,X as E,R as V,u as J,a as M,c as w,D as Q,C as U,k as $,l as B}from"./index-DedAuGlY.js";import{C as K}from"./AddCustomerForm-CJag3eyd.js";import{D as T}from"./DataTable-wi21OHCC.js";import{I as q}from"./input-CJ8UGXAQ.js";import{F as v}from"./FormInput-YgIorFMR.js";import{e as z,a as H,b as X,c as Y,d as _}from"./select-Cfpajtue.js";import{g as G}from"./customer-gawJjULT.js";import{g as W}from"./products-CqNwhZQJ.js";import{s as Z}from"./transaction-BHRmm8md.js";const ee=({products:h,onChange:x,setAmount:C})=>{const[d,b]=l.useState(""),[n,u]=l.useState([]),j=l.useMemo(()=>h.filter(t=>t.name.toLowerCase().includes(d.toLowerCase())||t.code.toLowerCase().includes(d.toLowerCase())),[h,d]),i=t=>{const a=n.find(r=>r.id===t.id);if(a)g(t.id,a.qty+1);else{const r=[...n,{...t,qty:1}];u(r),x(r)}},g=(t,a)=>{var p;if(a>((p=h.find(o=>o.id===t))==null?void 0:p.quantity)){alert("الكمية المطلوبة غير متوفرة في المخزون");return}const r=n.map(o=>o.id===t?{...o,qty:a}:o).filter(o=>o.qty>=0);u(r),x(r)},c=t=>{const a=n.filter(r=>r.id!==t);u(a),x(a)},m=n.reduce((t,a)=>t+a.sellPrice*a.qty,0);return l.useEffect(()=>{C(m)},[m]),e.jsxs("div",{className:"p-4 bg-white rounded-lg shadow",children:[e.jsx("h3",{className:"text-lg font-bold mb-2",children:"اختيار المنتجات"}),e.jsx(q,{placeholder:"ابحث عن المنتج بالاسم أو الكود...",value:d,onChange:t=>b(t.target.value),className:"mb-2"}),d&&j.length>0&&e.jsx("div",{className:"max-h-40 overflow-y-auto border p-2 rounded mb-4",children:j.map(t=>e.jsxs("div",{className:"flex justify-between items-center p-1 hover:bg-gray-100 cursor-pointer",onClick:()=>i(t),children:[e.jsxs("span",{children:[t.name," (",t.code,") - $",t.sellPrice]}),e.jsxs("span",{children:["المخزون: ",t.quantity]})]},t.id))}),n.length>0&&e.jsxs("table",{className:"w-full border-collapse",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"border p-1",children:"المنتج"}),e.jsx("th",{className:"border p-1",children:"الكود"}),e.jsx("th",{className:"border p-1",children:"السعر"}),e.jsx("th",{className:"border p-1",children:"الكمية"}),e.jsx("th",{className:"border p-1",children:"المجموع"}),e.jsx("th",{className:"border p-1",children:"حذف"})]})}),e.jsxs("tbody",{children:[n.map(t=>e.jsxs("tr",{children:[e.jsx("td",{className:"border p-1",children:t.name}),e.jsx("td",{className:"border p-1",children:t.code}),e.jsxs("td",{className:"border p-1",children:["$",t.sellPrice]}),e.jsx("td",{className:"border p-1",children:e.jsx(q,{type:"number",min:1,value:t.qty,onChange:a=>g(t.id,Number(a.target.value)),className:"w-16"})}),e.jsxs("td",{className:"border p-1",children:["$",(t.sellPrice*t.qty).toFixed(2)]}),e.jsx("td",{className:"border p-1 text-center",children:e.jsx(S,{variant:"destructive",size:"sm",onClick:()=>c(t.id),children:e.jsx(E,{})})})]},t.id)),e.jsxs("tr",{children:[e.jsx("td",{colSpan:4,className:"border p-1 font-bold text-right",children:"الإجمالي"}),e.jsxs("td",{colSpan:2,className:"border p-1 font-bold",children:["$",m.toFixed(2)]})]})]})]})]})};function he(){const[h,x]=V.useState(!1),[C,d]=l.useState([]),[b,n]=l.useState(""),[u,j]=l.useState(""),[i,g]=l.useState(0),[c,m]=l.useState([]),[t,a]=l.useState("cash"),[r,p]=l.useState(""),o=J(),[f,D]=l.useState(""),[y,k]=l.useState(1),F=M({mutationFn:s=>Z({newSell:s}),onSuccess:()=>{alert("تم بيع المنتج بنجاح!"),d([]),n(""),j(""),g(0),m([]),a("cash"),p(""),o.invalidateQueries({queryKey:["sells-table"]})},onError:s=>{console.error(s),alert("حدث خطأ أثناء بيع المنتج")}}),R=s=>c.some(N=>JSON.stringify(N)===JSON.stringify(s)),L=s=>{m(N=>R(s)?N.filter(A=>JSON.stringify(A)!==JSON.stringify(s)):[s])},{data:P,isLoading:te}=w({queryKey:["products-table"],queryFn:W});l.useEffect(()=>{g(Number((Number(u)-Number(b)).toFixed(3)))},[b,u]);const{data:O,isLoading:se}=w({queryKey:["customers-table"],queryFn:G}),I=[{key:"id",label:"الرمز",sortable:!0,hidden:!0},{key:"name",label:"الاسم",sortable:!0},{key:"number",label:"الرقم",sortable:!0}];return e.jsx(Q,{children:e.jsxs(U,{children:[e.jsx($,{children:e.jsx("h1",{className:"text-2xl font-bold",children:"بيع المنتجات"})}),e.jsxs(B,{className:"grid grid-cols-1 md:grid-cols-3 gap-2",children:[e.jsx("div",{className:"md:col-span-1",children:e.jsx(T,{title:"الزبائن",titleButton:e.jsx(K,{isOpen:h,setIsOpen:x,className:"w-full mb-2"}),columns:I||[],data:O||[],onRowClick:s=>L(s),getRowClassName:s=>c!=null&&c.some(N=>N===s)?"bg-green-50 hover:bg-green-100":""})}),e.jsx("div",{className:"md:col-span-2",children:e.jsx(ee,{products:P?Object.values(P||{}).flatMap(s=>Object.values(s)):[],setAmount:j,onChange:s=>d(s)})}),e.jsxs("form",{className:"md:col-span-3 mt-8 grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsx(v,{label:"الحسم",id:"discount-amount",type:"text",value:b,onChange:s=>n(s.target.value)}),e.jsx(v,{label:"السعر النهائي",id:"discount-amount",type:"text",value:i.toString(),onChange:s=>{}}),e.jsxs("div",{className:"grid grid-cols-3 gap-2 md:col-span-2",children:[e.jsx(S,{onClick:()=>{a("cash")},className:"col-span-1",variant:t==="cash"?"default":"outline",type:"button",children:"نقدا"}),e.jsx(S,{onClick:()=>{a("part")},className:"col-span-1",variant:t==="part"?"default":"outline",type:"button",children:"جزئي"}),e.jsx(S,{onClick:()=>{a("debt")},className:"col-span-1",variant:t==="debt"?"default":"outline",type:"button",children:"دين"})]}),t==="part"&&e.jsx(v,{id:"partPayment",label:"قيمة الدفعة",value:r.toString(),onChange:s=>p(s.target.value)}),t!="debt"&&e.jsxs(e.Fragment,{children:[" ",e.jsxs(z,{value:f,onValueChange:D,children:[e.jsx(H,{className:"w-full mt-6",children:e.jsx(X,{placeholder:"العملة المدفوع بها"})}),e.jsx(Y,{children:["SYP","USD"].map(s=>e.jsx(_,{value:s,children:s},s))})]}),e.jsx(v,{id:"exchangeRate",label:"سعر الصرف",value:f=="USD"?1:y,onChange:s=>k(Number(s.target.value)),disabled:f==="USD"})]}),e.jsx(S,{className:"w-full md:col-span-2",variant:"accent",onClick:s=>{if(s.preventDefault(),c.length<=0){alert("الرجاء التأكد من اختيار زبون");return}F.mutate({customerId:c.length>0?c[0].id:"نقدي",totalPrice:i,products:C,paymentStatus:t==="cash"?"cash":t==="part"?"part":"debt",remainingDebt:t==="cash"?0:t==="part"?i-(f=="USD"?Number(r):Number((Number(r)/y).toFixed(1))):i,currency:f,exchangeRate:y,amount_base:i*y,partValue:Number(r)})},children:"اتمام عملية البيع"})]})]})]})})}export{he as default};
