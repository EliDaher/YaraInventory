import{r,f as L,j as e,i as te,z as se,u as ae}from"./index-H-wgWPw7.js";import{P as k,F as p,S as re,a as Q,b as B,c as K,d as M,e as ne}from"./FormInput-CFG--yAp.js";import{B as d}from"./button-CZhGKD8l.js";import{u as q,D as le}from"./badge-gArzQKeM.js";import{p as z,h as oe}from"./transaction-w3A0Fkwy.js";import{D as V}from"./DataTable-Cl6Cf74j.js";import{P as ie}from"./PaymentTypeSelector-BiLDxjsh.js";import{C as E,b as ue}from"./card-C8MkjIzB.js";import{b as ce}from"./customer-K5Rhq7Uc.js";import{A as me}from"./arrow-left-DVT3Bd9K.js";import{C as de,S as pe}from"./Skeleton-BLcRP7ec.js";import{C as U}from"./CardContent-DrCDtA0S.js";import"./input-BZKj_cJR.js";import"./house-DbJPSTe7.js";import"./table-CU58WfWl.js";import"./search-CSdeKlk2.js";import"./DefaultPropsProvider-B-m9S4n3.js";import"./useSlot-CDyr-b9j.js";function xe({isOpen:o,setIsOpen:x,customerData:u}){const[y,j]=r.useState("cash"),[D,f]=r.useState(0),[i,h]=r.useState(0),[b,N]=r.useState(""),[m,w]=r.useState(""),[g,c]=r.useState(1),P=L(),S=q({mutationFn:a=>z(a),onSuccess:()=>{alert("تم إضافة الدفعة بنجاح!"),h(0),N(""),w(""),c(1),x(!1),P.invalidateQueries({queryKey:["customer-details"]})},onError:a=>{console.error(a),alert("حدث خطأ أثناء إضافة المنتج")}});return e.jsx(k,{title:"اضافة دفعة",trigger:e.jsx(d,{onClick:a=>{x(!0),a.stopPropagation()},variant:"accent",size:"sm",className:"w-full",children:"اضافة دفعة من الزبون"}),isOpen:o,setIsOpen:x,children:e.jsxs("form",{className:"space-y-4 mt-4",onSubmit:a=>{a.preventDefault(),S.mutate({customerId:u.id,amount:m=="USD"?i:Number((i/g).toFixed(1)),note:b,currency:m,exchangeRate:g,amount_base:i})},children:[e.jsx(p,{label:"قيمة الدفعة",id:"payment-amount",type:"number",value:i.toString(),onChange:a=>h(Number(a.target.value))}),e.jsx(p,{label:"ملاحظات",id:"note",type:"text",value:b,onChange:a=>N(a.target.value)}),y!="debt"&&e.jsxs(e.Fragment,{children:[" ",e.jsxs(re,{value:m,onValueChange:w,children:[e.jsx(Q,{className:"w-full mt-6",children:e.jsx(B,{placeholder:"العملة المدفوع بها"})}),e.jsx(K,{children:["SYP","USD"].map(a=>e.jsx(M,{value:a,children:a},a))})]}),e.jsx(p,{id:"exchangeRate",label:"سعر الصرف",value:m=="USD"?1:g,onChange:a=>c(Number(a.target.value)),disabled:m==="USD"})]}),e.jsx(d,{className:"w-full",type:"submit",children:"اضافة دفعة"})]})})}const I=o=>{if(!o)return 0;if(!isNaN(Number(o)))return Number(o);const x=new Date(o);if(!isNaN(x.getTime()))return x.getTime();if(o.includes(",")&&o.includes("/")){const[u,y]=o.split(","),[j,D,f]=u.split(":").map(Number),[i,h,b]=y.split("/").map(Number);return new Date(b,h-1,i,j,D,f).getTime()}return 0};function Te(){const o=te(),u=se().state,[y,j]=r.useState(!1),[D,f]=r.useState(!1),[i,h]=r.useState(0),[b,N]=r.useState(""),m=L(),[w,g]=r.useState(null),[c,P]=r.useState({}),[S,a]=r.useState("cash"),[F,Y]=r.useState(0),[T,_]=r.useState(""),[C,O]=r.useState(""),[R,A]=r.useState(1),$=q({mutationFn:t=>z(t),onSuccess:()=>{alert("تم إضافة الدفعة بنجاح!"),h(0),N(""),O(""),A(1),f(!1),j(!1),m.invalidateQueries({queryKey:["customer-details"]})},onError:t=>{console.error(t),alert("حدث خطأ أثناء إضافة المنتج")}}),G=q({mutationFn:t=>oe(t),onSuccess:()=>{m.invalidateQueries({queryKey:["customer-details"]})},onError:t=>{console.error(t),alert("حدث خطأ أثناء الإرجاع")}}),[H,J]=r.useState({}),{data:l,isLoading:W}=ae({queryKey:["customer-details",u],queryFn:()=>ce(u),enabled:!!u});l&&H.id!==l.id&&J(l);const X=[{label:"المعرف",key:"id",hidden:!0},{label:"المبلغ",key:"amount"},{label:"الوصف",key:"note"},{label:"التاريخ",key:"date"}],Z=[{label:"المعرف",key:"id",hidden:!0},{label:"السعر النهائي",key:"totalPrice"},{label:"المنتجات",key:"productsString"},{label:"التاريخ",key:"date"}];return e.jsx(le,{children:e.jsxs("div",{className:"space-y-6",dir:"rtl",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h1",{className:"text-3xl font-bold",children:"بيانات الزبون"}),e.jsxs(d,{onClick:()=>o(-1),variant:"outline",children:[e.jsx(me,{className:"ml-2 w-4 h-4"})," رجوع"]})]}),e.jsxs(E,{children:[e.jsx(de,{children:e.jsx(ue,{children:"المعلومات الأساسية"})}),e.jsxs(U,{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[l&&Object.entries(l.data).map(([t,s])=>["payments","purchases","id"].includes(t)?null:e.jsxs("p",{className:"flex gap-2 relative group mb-4 items-end",children:[e.jsxs("label",{className:"block font-bold w-36",children:[t,":"]}),t.includes("date")&&new Date(s).toString()!=="Invalid Date"?e.jsx("input",{type:"text",value:new Date(s).toLocaleString("en-GB"),readOnly:!0,className:"bg-transparent border-b-2 border-transparent focus:border-primary-500 outline-none transition-all w-full"}):e.jsx("input",{type:"text",value:s,readOnly:!0,className:"bg-transparent border-b-2 border-transparent focus:border-primary-500 outline-none transition-all w-full"}),e.jsx("span",{className:"absolute bottom-0 right-0 w-full h-[2px] bg-primary-500 scale-x-0 group-hover:scale-x-100 origin-right transition-transform duration-300"})]},t)),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(xe,{isOpen:D,setIsOpen:f,customerData:u}),e.jsx(k,{title:"دفع للزبون",trigger:e.jsx(d,{onClick:t=>{j(!0),t.stopPropagation()},variant:"destructive",size:"sm",className:"w-full",children:"دفع للزبون"}),isOpen:y,setIsOpen:j,children:e.jsxs("form",{className:"space-y-4 mt-4",onSubmit:t=>{t.preventDefault(),$.mutate({customerId:u.id,amount:C=="USD"?-i:-Number((i/R).toFixed(1)),note:b,currency:C,exchangeRate:R,amount_base:-i})},children:[e.jsx(p,{label:"قيمة الدفعة",id:"payment-amount",type:"number",value:i.toString(),onChange:t=>h(Number(t.target.value))}),e.jsx(p,{label:"ملاحظات",id:"note",type:"text",value:b,onChange:t=>N(t.target.value)}),S!="debt"&&e.jsxs(e.Fragment,{children:[" ",e.jsxs(ne,{value:C,onValueChange:O,children:[e.jsx(Q,{className:"w-full mt-6",children:e.jsx(B,{placeholder:"العملة المدفوع بها"})}),e.jsx(K,{children:["SYP","USD"].map(t=>e.jsx(M,{value:t,children:t},t))})]}),e.jsx(p,{id:"exchangeRate",label:"سعر الصرف",value:C=="USD"?1:R,onChange:t=>A(Number(t.target.value)),disabled:C==="USD"})]}),e.jsx(d,{className:"w-full",type:"submit",children:"اضافة دفعة"})]})})]})]})]}),e.jsx(E,{className:"overflow-x-auto",children:W?e.jsx(pe,{className:"h-48 w-full"}):l!=null&&l.data?e.jsxs(U,{className:"space-y-4 md:space-y-0 grid md:grid-cols-1 gap-4",children:[e.jsx(V,{title:"الدفعات",columns:X,data:[...(l==null?void 0:l.data.payments)??[]].sort((t,s)=>I(s.date)-I(t.date))}),e.jsx(V,{title:"عمليات الشراء",columns:Z,data:l?l.data.purchases.filter(t=>Array.isArray(t.products)&&t.products.length>0).map(t=>({...t,productsString:t.products.map(s=>s.name).join(", ")})).sort((t,s)=>I(s.date)-I(t.date)):[],renderRowActions:t=>e.jsxs("div",{className:"flex gap-2",children:[e.jsx(d,{variant:"outline",onClick:()=>{o("/sellDetails",{state:t.id})},children:"تفاصيل"}),e.jsx(k,{title:"إرجاع منتجات الفاتورة",isOpen:w===t.id,setIsOpen:()=>g(null),trigger:e.jsx(d,{onClick:s=>{s.stopPropagation(),g(t.id)},children:"إرجاع"}),children:e.jsxs("form",{className:"space-y-4",onSubmit:s=>{s.preventDefault(),t.products.filter(n=>(Number(c[n.id])||0)>0).map(n=>({productId:n.id,productCode:n.code,customerId:t.customerId,warehouse:n.warehouse,qty:-Number(c[n.id]),returnValue:Number(c[n.id])*n.sellPrice,referenceId:t.id,partValue:F,returnType:S,reason:T})).forEach(n=>{console.log(n),G.mutate(n)}),alert("تم تسجيل الإرجاع بنجاح!"),g(null),P({})},children:[e.jsx("div",{className:"max-h-96 overflow-y-auto mt-4 border-2 rounded-md ",children:t.products.map(s=>e.jsxs("div",{className:"border p-2 rounded-md",children:[e.jsx("p",{className:"font-semibold",children:s.name}),e.jsxs("p",{children:["الكمية الأصلية: ",s.qty]}),e.jsxs("p",{children:["سعر الوحدة: ",s.sellPrice]}),e.jsxs("p",{children:["المستودع: ",s.warehouse]}),e.jsx(p,{id:`return-${s.id}`,label:"كمية الإرجاع",value:(c[s.id]||0).toString(),onChange:v=>{let n=v.target.value;n>s.qty&&(n=s.qty),P(ee=>({...ee,[s.id]:n}))}}),e.jsxs("p",{children:["المبلغ:"," ",(Number(c[s.id])||0)*s.sellPrice]})]},s.id))}),e.jsxs("p",{className:"font-bold",children:["المجموع الكلي:"," ",t.products.reduce((s,v)=>s+(Number(c[v.id])||0)*v.sellPrice,0)]}),e.jsx(ie,{value:S,onChange:a,partValue:F,onPartValueChange:s=>Y(s)}),e.jsx(p,{id:"return-reason",label:"ملاحظات",type:"text",value:T,onChange:s=>{_(s.target.value)}}),e.jsx(d,{type:"submit",className:"w-full",children:"تأكيد الإرجاع"})]})})]})})]}):e.jsx("p",{className:"text-muted-foreground text-center",children:"لا توجد معاملات حالياً."})})]})})}export{Te as default};
