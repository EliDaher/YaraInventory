import{r,h as K,j as e,B as d,m as te,a0 as se,f as ae,D as re}from"./index-B9Hbub3a.js";import{P as q,F as p,S as ne,a as L,b as M,c as B,d as z,e as le}from"./FormInput-Cd4NdAnV.js";import{u as w}from"./badge-B0P1iBeR.js";import{p as Y,h as oe}from"./transaction-f63TGXsa.js";import{C as ie,D as ue,S as ce}from"./Skeleton-C1epdoEp.js";import{D as U}from"./DataTable-Dhrv2TO0.js";import{P as me}from"./PaymentTypeSelector-gS2GznI_.js";import{C as O,b as de}from"./card-DW6a6Si8.js";import{b as pe}from"./customer-C8Pj8vHY.js";import{A as xe}from"./arrow-left-BLzokWtU.js";import{C as Q}from"./CardContent-Cm2N3j24.js";import"./input-2o4aYGpX.js";import"./supplier-8jLn8UfL.js";import"./DefaultPropsProvider-DCkKgH5C.js";import"./useSlot-Bsmm1Szi.js";import"./table-Dn0IiQCR.js";import"./search-C1TpxlMX.js";function he({isOpen:o,setIsOpen:x,customerData:u}){const[y,g]=r.useState("cash"),[D,f]=r.useState(0),[i,h]=r.useState(0),[j,S]=r.useState(""),[m,P]=r.useState(""),[b,c]=r.useState(1),I=K(),N=w({mutationFn:a=>Y(a),onSuccess:()=>{alert("تم إضافة الدفعة بنجاح!"),h(0),S(""),P(""),c(1),x(!1),I.invalidateQueries({queryKey:["customer-details"]})},onError:a=>{console.error(a),alert("حدث خطأ أثناء إضافة المنتج")}});return e.jsx(q,{title:"اضافة دفعة",trigger:e.jsx(d,{onClick:a=>{x(!0),a.stopPropagation()},variant:"accent",size:"sm",className:"w-full",children:"اضافة دفعة من الزبون"}),isOpen:o,setIsOpen:x,children:e.jsxs("form",{className:"space-y-4 mt-4",onSubmit:a=>{a.preventDefault(),N.mutate({customerId:u.id,amount:m=="USD"?i:Number((i/b).toFixed(1)),note:j,currency:m,exchangeRate:b,amount_base:i})},children:[e.jsx(p,{label:"قيمة الدفعة",id:"payment-amount",type:"number",value:i.toString(),onChange:a=>h(Number(a.target.value))}),e.jsx(p,{label:"ملاحظات",id:"note",type:"text",value:j,onChange:a=>S(a.target.value)}),y!="debt"&&e.jsxs(e.Fragment,{children:[" ",e.jsxs(ne,{value:m,onValueChange:P,children:[e.jsx(L,{className:"w-full mt-6",children:e.jsx(M,{placeholder:"العملة المدفوع بها"})}),e.jsx(B,{children:["SYP","USD"].map(a=>e.jsx(z,{value:a,children:a},a))})]}),e.jsx(p,{id:"exchangeRate",label:"سعر الصرف",value:m=="USD"?1:b,onChange:a=>c(Number(a.target.value)),disabled:m==="USD"})]}),e.jsx(d,{className:"w-full",type:"submit",children:"اضافة دفعة"})]})})}const R=o=>{if(!o)return 0;if(!isNaN(Number(o)))return Number(o);const x=new Date(o);if(!isNaN(x.getTime()))return x.getTime();if(o.includes(",")&&o.includes("/")){const[u,y]=o.split(","),[g,D,f]=u.split(":").map(Number),[i,h,j]=y.split("/").map(Number);return new Date(j,h-1,i,g,D,f).getTime()}return 0};function Te(){const o=te(),u=se().state,[y,g]=r.useState(!1),[D,f]=r.useState(!1),[i,h]=r.useState(0),[j,S]=r.useState(""),m=K(),[P,b]=r.useState(null),[c,I]=r.useState({}),[N,a]=r.useState("cash"),[F,_]=r.useState(0),[T,$]=r.useState(""),[C,A]=r.useState(""),[k,E]=r.useState(1),H=w({mutationFn:t=>Y(t),onSuccess:()=>{alert("تم إضافة الدفعة بنجاح!"),h(0),S(""),A(""),E(1),f(!1),g(!1),m.invalidateQueries({queryKey:["customer-details"]})},onError:t=>{console.error(t),alert("حدث خطأ أثناء إضافة المنتج")}}),G=w({mutationFn:t=>oe(t),onSuccess:()=>{m.invalidateQueries({queryKey:["customer-details"]})},onError:t=>{console.error(t),alert("حدث خطأ أثناء الإرجاع")}}),[J,V]=r.useState({}),{data:l,isLoading:W}=ae({queryKey:["customer-details",u],queryFn:()=>pe(u),enabled:!!u});r.useEffect(()=>{l!=null&&l.data&&V(l.data)},[l]);const X=[{label:"المعرف",key:"id",hidden:!0},{label:"المبلغ",key:"amount"},{label:"الوصف",key:"note"},{label:"التاريخ",key:"date"}],Z=[{label:"المعرف",key:"id",hidden:!0},{label:"السعر النهائي",key:"totalPrice"},{label:"المنتجات",key:"productsString"},{label:"التاريخ",key:"date"}];return e.jsx(re,{children:e.jsxs("div",{className:"space-y-6",dir:"rtl",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h1",{className:"text-3xl font-bold",children:"بيانات الزبون"}),e.jsxs(d,{onClick:()=>o(-1),variant:"outline",children:[e.jsx(xe,{className:"ml-2 w-4 h-4"})," رجوع"]})]}),e.jsxs(O,{children:[e.jsx(ie,{children:e.jsx(de,{children:"المعلومات الأساسية"})}),e.jsxs(Q,{className:"grid grid-cols-1 gap-4",children:[e.jsx(ue,{customer:J,setCustomer:V}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(he,{isOpen:D,setIsOpen:f,customerData:u}),e.jsx(q,{title:"دفع للزبون",trigger:e.jsx(d,{onClick:t=>{g(!0),t.stopPropagation()},variant:"destructive",size:"sm",className:"w-full",children:"دفع للزبون"}),isOpen:y,setIsOpen:g,children:e.jsxs("form",{className:"space-y-4 mt-4",onSubmit:t=>{t.preventDefault(),H.mutate({customerId:u.id,amount:C=="USD"?-i:-Number((i/k).toFixed(1)),note:j,currency:C,exchangeRate:k,amount_base:-i})},children:[e.jsx(p,{label:"قيمة الدفعة",id:"payment-amount",type:"number",value:i.toString(),onChange:t=>h(Number(t.target.value))}),e.jsx(p,{label:"ملاحظات",id:"note",type:"text",value:j,onChange:t=>S(t.target.value)}),N!="debt"&&e.jsxs(e.Fragment,{children:[" ",e.jsxs(le,{value:C,onValueChange:A,children:[e.jsx(L,{className:"w-full mt-6",children:e.jsx(M,{placeholder:"العملة المدفوع بها"})}),e.jsx(B,{children:["SYP","USD"].map(t=>e.jsx(z,{value:t,children:t},t))})]}),e.jsx(p,{id:"exchangeRate",label:"سعر الصرف",value:C=="USD"?1:k,onChange:t=>E(Number(t.target.value)),disabled:C==="USD"})]}),e.jsx(d,{className:"w-full",type:"submit",children:"اضافة دفعة"})]})})]})]})]}),e.jsx(O,{className:"overflow-x-auto",children:W?e.jsx(ce,{className:"h-48 w-full"}):l!=null&&l.data?e.jsxs(Q,{className:"space-y-4 md:space-y-0 grid md:grid-cols-1 gap-4",children:[e.jsx(U,{title:"الدفعات",columns:X,data:[...(l==null?void 0:l.data.payments)??[]].sort((t,s)=>R(s.date)-R(t.date))}),e.jsx(U,{title:"عمليات الشراء",columns:Z,data:l?l.data.purchases.filter(t=>Array.isArray(t.products)&&t.products.length>0).map(t=>({...t,productsString:t.products.map(s=>s.name).join(", ")})).sort((t,s)=>R(s.date)-R(t.date)):[],renderRowActions:t=>e.jsxs("div",{className:"flex gap-2",children:[e.jsx(d,{variant:"outline",onClick:()=>{o("/sellDetails",{state:t.id})},children:"تفاصيل"}),e.jsx(q,{title:"إرجاع منتجات الفاتورة",isOpen:P===t.id,setIsOpen:()=>b(null),trigger:e.jsx(d,{onClick:s=>{s.stopPropagation(),b(t.id)},children:"إرجاع"}),children:e.jsxs("form",{className:"space-y-4",onSubmit:s=>{s.preventDefault(),t.products.filter(n=>(Number(c[n.id])||0)>0).map(n=>({productId:n.id,productCode:n.code,customerId:t.customerId,warehouse:n.warehouse,qty:-Number(c[n.id]),returnValue:Number(c[n.id])*n.sellPrice,referenceId:t.id,partValue:F,returnType:N,reason:T})).forEach(n=>{console.log(n),G.mutate(n)}),alert("تم تسجيل الإرجاع بنجاح!"),b(null),I({})},children:[e.jsx("div",{className:"max-h-96 overflow-y-auto mt-4 border-2 rounded-md ",children:t.products.map(s=>e.jsxs("div",{className:"border p-2 rounded-md",children:[e.jsx("p",{className:"font-semibold",children:s.name}),e.jsxs("p",{children:["الكمية الأصلية: ",s.qty]}),e.jsxs("p",{children:["سعر الوحدة: ",s.sellPrice]}),e.jsxs("p",{children:["المستودع: ",s.warehouse]}),e.jsx(p,{id:`return-${s.id}`,label:"كمية الإرجاع",value:(c[s.id]||0).toString(),onChange:v=>{let n=v.target.value;n>s.qty&&(n=s.qty),I(ee=>({...ee,[s.id]:n}))}}),e.jsxs("p",{children:["المبلغ:"," ",(Number(c[s.id])||0)*s.sellPrice]})]},s.id))}),e.jsxs("p",{className:"font-bold",children:["المجموع الكلي:"," ",t.products.reduce((s,v)=>s+(Number(c[v.id])||0)*v.sellPrice,0)]}),e.jsx(me,{value:N,onChange:a,partValue:F,onPartValueChange:s=>_(s)}),e.jsx(p,{id:"return-reason",label:"ملاحظات",type:"text",value:T,onChange:s=>{$(s.target.value)}}),e.jsx(d,{type:"submit",className:"w-full",children:"تأكيد الإرجاع"})]})})]})})]}):e.jsx("p",{className:"text-muted-foreground text-center",children:"لا توجد معاملات حالياً."})})]})})}export{Te as default};
