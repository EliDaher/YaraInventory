import{r as l,j as e,J as C,R as O,f as V,e as q,h as Q}from"./index-DXJC0gxo.js";import{C as U}from"./AddCustomerForm-DRGt_ls2.js";import{D as B}from"./DataTable-DfamvYLU.js";import{D as K}from"./badge-COXlAnRb.js";import{I as P}from"./input-B8413TkC.js";import{B as N}from"./button-Dl2RVhdx.js";import{X as M,F as v,S as T,a as $,b as z,c as H,d as X}from"./FormInput-jf5cEK0U.js";import{C as Y,a as _,c as G}from"./card-k2cBTq1y.js";import{g as W}from"./customer-iYI0gmL3.js";import{s as Z}from"./transaction-1HPbfY7p.js";import{u as ee}from"./useMutation-9gywVg79.js";import"./table-Cz6ToIEw.js";import"./search-lZXwueMP.js";import"./user-CYuIBy2Y.js";import"./house-CF7zLO4F.js";const te=({products:b,onChange:x,setAmount:w})=>{const[u,g]=l.useState(""),[c,m]=l.useState([]),j=l.useMemo(()=>b.filter(t=>{var a,r;return((a=t==null?void 0:t.name)==null?void 0:a.toLowerCase().includes(u.toLowerCase()))||((r=t==null?void 0:t.code)==null?void 0:r.toLowerCase().includes(u.toLowerCase()))}),[b,u]),h=t=>{const a=c.find(r=>r.id===t.id);if(a)p(t.id,a.qty+1);else{const r=[...c,{...t,qty:1}];m(r),x(r)}},p=(t,a)=>{var d;if(a>((d=b.find(o=>o.id===t))==null?void 0:d.quantity)){C.error("الكمية المطلوبة غير متوفرة في المخزون");return}const r=c.map(o=>o.id===t?{...o,qty:a}:o).filter(o=>o.qty>=0);m(r),x(r)},i=(t,a)=>{const r=c.map(d=>d.id===t?{...d,sellPrice:a}:d).filter(d=>d.qty>=0);m(r),x(r)},S=t=>{const a=c.filter(r=>r.id!==t);m(a),x(a)},n=c.reduce((t,a)=>t+a.sellPrice*a.qty,0);return l.useEffect(()=>{w(n)},[n]),e.jsxs("div",{className:"p-4 bg-white rounded-lg shadow",children:[e.jsx("h3",{className:"text-lg font-bold mb-2",children:"اختيار المنتجات"}),e.jsx(P,{placeholder:"ابحث عن المنتج بالاسم أو الكود...",value:u,onChange:t=>g(t.target.value),className:"mb-2"}),u&&j.length>0&&e.jsx("div",{className:"max-h-40 overflow-y-auto border p-2 rounded mb-4",children:j.map(t=>e.jsxs("div",{className:"flex justify-between items-center p-1 hover:bg-gray-100 cursor-pointer",onClick:()=>h(t),children:[e.jsxs("span",{children:[t.name," (",t.code,") - $",t.sellPrice," / ",t.warehouse]}),e.jsxs("span",{children:["المخزون: ",t.quantity]})]},t.id))}),c.length>0&&e.jsxs("table",{className:"w-full border-collapse",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"border p-1",children:"المنتج"}),e.jsx("th",{className:"border p-1",children:"الكود"}),e.jsx("th",{className:"border p-1",children:"السعر"}),e.jsx("th",{className:"border p-1",children:"الكمية"}),e.jsx("th",{className:"border p-1",children:"المجموع"}),e.jsx("th",{className:"border p-1",children:"حذف"})]})}),e.jsxs("tbody",{children:[c.map(t=>e.jsxs("tr",{children:[e.jsx("td",{className:"border p-1",children:t.name}),e.jsx("td",{className:"border p-1",children:t.code}),e.jsx("td",{className:"border p-1",children:e.jsx(P,{type:"number",min:0,value:t.sellPrice,onChange:a=>i(t.id,Number(a.target.value)),className:"w-16"})}),e.jsx("td",{className:"border p-1",children:e.jsx(P,{type:"number",min:1,value:t.qty,onChange:a=>p(t.id,Number(a.target.value)),className:"w-16"})}),e.jsxs("td",{className:"border p-1",children:["$",(t.sellPrice*t.qty).toFixed(2)]}),e.jsx("td",{className:"border p-1 text-center",children:e.jsx(N,{variant:"destructive",size:"sm",onClick:()=>S(t.id),children:e.jsx(M,{})})})]},t.id)),e.jsxs("tr",{children:[e.jsx("td",{colSpan:4,className:"border p-1 font-bold text-right",children:"الإجمالي"}),e.jsxs("td",{colSpan:2,className:"border p-1 font-bold",children:["$",n.toFixed(2)]})]})]})]})]})};function Ne(){const[b,x]=O.useState(!1),[w,u]=l.useState([]),[g,c]=l.useState(""),[m,j]=l.useState(""),[h,p]=l.useState(0),[i,S]=l.useState([]),[n,t]=l.useState("cash"),[a,r]=l.useState(""),d=V(),[o,D]=l.useState(""),[y,F]=l.useState(1),k=ee({mutationFn:s=>Z({newSell:s}),onSuccess:()=>{C.success("تم بيع المنتج بنجاح!"),u([]),c(""),j(""),p(0),S([]),t("cash"),r(""),d.invalidateQueries({queryKey:["sells-table"]})},onError:s=>{console.error(s),C.error("حدث خطأ أثناء بيع المنتج")}}),R=s=>i.some(f=>JSON.stringify(f)===JSON.stringify(s)),L=s=>{S(f=>R(s)?f.filter(J=>JSON.stringify(J)!==JSON.stringify(s)):[s])},{data:I,isLoading:se}=q({queryKey:["products-table"],queryFn:Q});l.useEffect(()=>{p(Number((Number(m)-Number(g)).toFixed(3)))},[g,m]);const{data:A,isLoading:ae}=q({queryKey:["customers-table"],queryFn:W}),E=[{key:"id",label:"الرمز",sortable:!0,hidden:!0},{key:"name",label:"الاسم",sortable:!0},{key:"number",label:"الرقم",sortable:!0}];return e.jsx(K,{children:e.jsxs(Y,{children:[e.jsx(_,{children:e.jsx("h1",{className:"text-2xl font-bold",children:"بيع المنتجات"})}),e.jsxs(G,{className:"grid grid-cols-1 md:grid-cols-3 gap-2",children:[e.jsx("div",{className:"md:col-span-1",children:e.jsx(B,{title:"الزبائن",titleButton:e.jsx(U,{isOpen:b,setIsOpen:x,className:"w-full mb-2"}),columns:E||[],data:A||[],onRowClick:s=>L(s),getRowClassName:s=>i!=null&&i.some(f=>f===s)?"bg-green-50 hover:bg-green-100":""})}),e.jsx("div",{className:"md:col-span-2",children:e.jsx(te,{products:I,setAmount:j,onChange:s=>u(s)})}),e.jsxs("form",{className:"md:col-span-3 mt-8 grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsx(v,{label:"الحسم",id:"discount-amount",type:"text",value:g,onChange:s=>c(s.target.value)}),e.jsx(v,{label:"السعر النهائي",id:"discount-amount",type:"text",value:h.toString(),onChange:s=>{}}),e.jsxs("div",{className:"grid grid-cols-3 gap-2 md:col-span-2",children:[e.jsx(N,{onClick:()=>{t("cash")},className:"col-span-1",variant:n==="cash"?"default":"outline",type:"button",children:"نقدا"}),e.jsx(N,{onClick:()=>{t("part")},className:"col-span-1",variant:n==="part"?"default":"outline",type:"button",children:"جزئي"}),e.jsx(N,{onClick:()=>{t("debt")},className:"col-span-1",variant:n==="debt"?"default":"outline",type:"button",children:"دين"})]}),n==="part"&&e.jsx(v,{id:"partPayment",label:"قيمة الدفعة",value:a.toString(),onChange:s=>r(s.target.value)}),n!="debt"&&e.jsxs(e.Fragment,{children:[" ",e.jsxs(T,{value:o,onValueChange:D,children:[e.jsx($,{className:"w-full mt-6",children:e.jsx(z,{placeholder:"العملة المدفوع بها"})}),e.jsx(H,{children:["SYP","USD"].map(s=>e.jsx(X,{value:s,children:s},s))})]}),e.jsx(v,{id:"exchangeRate",label:"سعر الصرف",value:o=="USD"?1:y,onChange:s=>F(Number(s.target.value)),disabled:o==="USD"})]}),e.jsx(N,{className:"w-full md:col-span-2",variant:"accent",onClick:s=>{if(s.preventDefault(),i.length<=0){C.error("الرجاء التأكد من اختيار زبون");return}k.mutate({customerId:i.length>0?i[0].id:"نقدي",totalPrice:h,products:w,paymentStatus:n==="cash"?"cash":n==="part"?"part":"debt",remainingDebt:n==="cash"?0:n==="part"?h-(o=="USD"?Number(a):Number((Number(a)/y).toFixed(1))):h,currency:o,exchangeRate:y,amount_base:h*y,partValue:Number(a)})},children:"اتمام عملية البيع"})]})]})]})})}export{Ne as default};
