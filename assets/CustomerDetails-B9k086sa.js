import{c as ee,a7 as te,r as n,u as se,a as F,d as ae,j as e,D as re,B as u,A as ne,C as A,a6 as le}from"./index-BaSnlIDM.js";import{D as U}from"./DataTable-C6oFKokI.js";import{P as ie}from"./PaymentTypeSelector-CCjKzgds.js";import{P,F as c,S as V,a as E,b as L,c as B,d as Q}from"./FormInput-BlxF78eT.js";import{b as oe}from"./customer-CTPJi7P1.js";import{a as ue,b as ce}from"./transaction-ke_jorcF.js";import{C as de,S as me}from"./Skeleton-CBp1iqUx.js";import{C as K}from"./CardContent-BxETiaAq.js";import"./input-_BL4U1zG.js";import"./DefaultPropsProvider-UNJqVgsU.js";import"./useSlot-SE3T33Pw.js";const f=l=>{if(!l)return 0;if(!isNaN(Number(l)))return Number(l);const N=new Date(l);if(!isNaN(N.getTime()))return N.getTime();if(l.includes(",")&&l.includes("/")){const[d,S]=l.split(","),[h,C,b]=d.split(":").map(Number),[i,g,m]=S.split("/").map(Number);return new Date(m,g-1,i,h,C,b).getTime()}return 0};function ve(){const l=ee(),d=te().state,[S,h]=n.useState(!1),[C,b]=n.useState(!1),[i,g]=n.useState(0),[m,v]=n.useState(""),R=se(),[M,D]=n.useState(null),[p,k]=n.useState({}),[y,z]=n.useState("cash"),[O,Y]=n.useState(0),[T,_]=n.useState(""),[o,w]=n.useState(""),[x,I]=n.useState(1),q=F({mutationFn:t=>ue(t),onSuccess:()=>{alert("تم إضافة الدفعة بنجاح!"),g(0),v(""),w(""),I(1),b(!1),h(!1),R.invalidateQueries({queryKey:["customer-details"]})},onError:t=>{console.error(t),alert("حدث خطأ أثناء إضافة المنتج")}}),G=F({mutationFn:t=>ce(t),onSuccess:()=>{R.invalidateQueries({queryKey:["customer-details"]})},onError:t=>{console.error(t),alert("حدث خطأ أثناء الإرجاع")}}),[H,$]=n.useState({}),{data:r,isLoading:J}=ae({queryKey:["customer-details",d],queryFn:()=>oe(d),enabled:!!d});r&&H.id!==r.id&&$(r);const W=[{label:"المعرف",key:"id",hidden:!0},{label:"المبلغ",key:"amount"},{label:"الوصف",key:"note"},{label:"التاريخ",key:"date"}],X=[{label:"المعرف",key:"id",hidden:!0},{label:"السعر النهائي",key:"totalPrice"},{label:"المنتجات",key:"productsString"},{label:"التاريخ",key:"date"}];return e.jsx(re,{children:e.jsxs("div",{className:"space-y-6",dir:"rtl",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h1",{className:"text-3xl font-bold",children:"بيانات الزبون"}),e.jsxs(u,{onClick:()=>l(-1),variant:"outline",children:[e.jsx(ne,{className:"ml-2 w-4 h-4"})," رجوع"]})]}),e.jsxs(A,{children:[e.jsx(de,{children:e.jsx(le,{children:"المعلومات الأساسية"})}),e.jsxs(K,{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[r&&Object.entries(r.data).map(([t,s])=>["payments","purchases","id"].includes(t)?null:e.jsxs("p",{className:"flex gap-2 relative group mb-4 items-end",children:[e.jsxs("label",{className:"block font-bold w-36",children:[t,":"]}),t.includes("date")&&new Date(s).toString()!=="Invalid Date"?e.jsx("input",{type:"text",value:new Date(s).toLocaleString("en-GB"),readOnly:!0,className:"bg-transparent border-b-2 border-transparent focus:border-primary-500 outline-none transition-all w-full"}):e.jsx("input",{type:"text",value:s,readOnly:!0,className:"bg-transparent border-b-2 border-transparent focus:border-primary-500 outline-none transition-all w-full"}),e.jsx("span",{className:"absolute bottom-0 right-0 w-full h-[2px] bg-primary-500 scale-x-0 group-hover:scale-x-100 origin-right transition-transform duration-300"})]},t)),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(P,{title:"اضافة دفعة",trigger:e.jsx(u,{onClick:t=>{b(!0),t.stopPropagation()},variant:"accent",size:"sm",className:"w-full",children:"اضافة دفعة من الزبون"}),isOpen:C,setIsOpen:b,children:e.jsxs("form",{className:"space-y-4 mt-4",onSubmit:t=>{t.preventDefault(),q.mutate({customerId:d.id,amount:o=="USD"?i:Number((i/x).toFixed(1)),note:m,currency:o,exchangeRate:x,amount_base:i})},children:[e.jsx(c,{label:"قيمة الدفعة",id:"payment-amount",type:"number",value:i.toString(),onChange:t=>g(Number(t.target.value))}),e.jsx(c,{label:"ملاحظات",id:"note",type:"text",value:m,onChange:t=>v(t.target.value)}),y!="debt"&&e.jsxs(e.Fragment,{children:[" ",e.jsxs(V,{value:o,onValueChange:w,children:[e.jsx(E,{className:"w-full mt-6",children:e.jsx(L,{placeholder:"العملة المدفوع بها"})}),e.jsx(B,{children:["SYP","USD"].map(t=>e.jsx(Q,{value:t,children:t},t))})]}),e.jsx(c,{id:"exchangeRate",label:"سعر الصرف",value:o=="USD"?1:x,onChange:t=>I(Number(t.target.value)),disabled:o==="USD"})]}),e.jsx(u,{className:"w-full",type:"submit",children:"اضافة دفعة"})]})}),e.jsx(P,{title:"دفع للزبون",trigger:e.jsx(u,{onClick:t=>{h(!0),t.stopPropagation()},variant:"destructive",size:"sm",className:"w-full",children:"دفع للزبون"}),isOpen:S,setIsOpen:h,children:e.jsxs("form",{className:"space-y-4 mt-4",onSubmit:t=>{t.preventDefault(),q.mutate({customerId:d.id,amount:o=="USD"?-i:-Number((i/x).toFixed(1)),note:m,currency:o,exchangeRate:x,amount_base:-i})},children:[e.jsx(c,{label:"قيمة الدفعة",id:"payment-amount",type:"number",value:i.toString(),onChange:t=>g(Number(t.target.value))}),e.jsx(c,{label:"ملاحظات",id:"note",type:"text",value:m,onChange:t=>v(t.target.value)}),y!="debt"&&e.jsxs(e.Fragment,{children:[" ",e.jsxs(V,{value:o,onValueChange:w,children:[e.jsx(E,{className:"w-full mt-6",children:e.jsx(L,{placeholder:"العملة المدفوع بها"})}),e.jsx(B,{children:["SYP","USD"].map(t=>e.jsx(Q,{value:t,children:t},t))})]}),e.jsx(c,{id:"exchangeRate",label:"سعر الصرف",value:o=="USD"?1:x,onChange:t=>I(Number(t.target.value)),disabled:o==="USD"})]}),e.jsx(u,{className:"w-full",type:"submit",children:"اضافة دفعة"})]})})]})]})]}),e.jsx(A,{className:"overflow-x-auto",children:J?e.jsx(me,{className:"h-48 w-full"}):r!=null&&r.data?e.jsxs(K,{className:"space-y-4 md:space-y-0 grid md:grid-cols-1 gap-4",children:[e.jsx(U,{title:"الدفعات",columns:W,data:[...(r==null?void 0:r.data.payments)??[]].sort((t,s)=>f(s.date)-f(t.date))}),e.jsx(U,{title:"عمليات الشراء",columns:X,data:r?r.data.purchases.filter(t=>Array.isArray(t.products)&&t.products.length>0).map(t=>({...t,productsString:t.products.map(s=>s.name).join(", ")})).sort((t,s)=>f(s.date)-f(t.date)):[],renderRowActions:t=>e.jsxs("div",{className:"flex gap-2",children:[e.jsx(u,{variant:"outline",onClick:()=>{l("/sellDetails",{state:t.id})},children:"تفاصيل"}),e.jsx(P,{title:"إرجاع منتجات الفاتورة",isOpen:M===t.id,setIsOpen:()=>D(null),trigger:e.jsx(u,{onClick:s=>{s.stopPropagation(),D(t.id)},children:"إرجاع"}),children:e.jsxs("form",{className:"space-y-4",onSubmit:s=>{s.preventDefault(),t.products.filter(a=>(Number(p[a.id])||0)>0).map(a=>({productId:a.id,productCode:a.code,customerId:t.customerId,warehouse:a.warehouse,qty:-Number(p[a.id]),returnValue:Number(p[a.id])*a.sellPrice,referenceId:t.id,partValue:O,returnType:y,reason:T})).forEach(a=>{console.log(a),G.mutate(a)}),alert("تم تسجيل الإرجاع بنجاح!"),D(null),k({})},children:[e.jsx("div",{className:"max-h-96 overflow-y-auto mt-4 border-2 rounded-md ",children:t.products.map(s=>e.jsxs("div",{className:"border p-2 rounded-md",children:[e.jsx("p",{className:"font-semibold",children:s.name}),e.jsxs("p",{children:["الكمية الأصلية: ",s.qty]}),e.jsxs("p",{children:["سعر الوحدة: ",s.sellPrice]}),e.jsxs("p",{children:["المستودع: ",s.warehouse]}),e.jsx(c,{id:`return-${s.id}`,label:"كمية الإرجاع",value:(p[s.id]||0).toString(),onChange:j=>{let a=j.target.value;a>s.qty&&(a=s.qty),k(Z=>({...Z,[s.id]:a}))}}),e.jsxs("p",{children:["المبلغ:"," ",(Number(p[s.id])||0)*s.sellPrice]})]},s.id))}),e.jsxs("p",{className:"font-bold",children:["المجموع الكلي:"," ",t.products.reduce((s,j)=>s+(Number(p[j.id])||0)*j.sellPrice,0)]}),e.jsx(ie,{value:y,onChange:z,partValue:O,onPartValueChange:s=>Y(s)}),e.jsx(c,{id:"return-reason",label:"ملاحظات",type:"text",value:T,onChange:s=>{_(s.target.value)}}),e.jsx(u,{type:"submit",className:"w-full",children:"تأكيد الإرجاع"})]})})]})})]}):e.jsx("p",{className:"text-muted-foreground text-center",children:"لا توجد معاملات حالياً."})})]})})}export{ve as default};
