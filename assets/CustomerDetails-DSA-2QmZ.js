import{r,f as L,j as e,J as y,l as se,z as ae,e as re}from"./index-D9SdI5e-.js";import{P as w,F as p,S as ne,a as M,b as z,c as B,d as J,e as le}from"./FormInput-CpqofyxA.js";import{B as d}from"./button-C_OZHrl6.js";import{u as F}from"./useMutation-lyefXRX2.js";import{p as Y,h as oe}from"./transaction-C4sBRcfg.js";import{C as ie,D as ue,S as ce}from"./Skeleton-CHPDx0Jf.js";import{D as O}from"./DataTable-3EKd1hnR.js";import{D as me}from"./badge-Dp2vQZdV.js";import{P as de}from"./PaymentTypeSelector-B2X27g7I.js";import{C as Q,b as pe}from"./card-ObnbIFWj.js";import{b as xe}from"./customer-DH1gCgY9.js";import{A as he}from"./arrow-left-IkUlHP5r.js";import{C as K}from"./CardContent-DE-tDXbB.js";import"./input-DkcmyAx5.js";import"./supplier-D1yL56Mb.js";import"./DefaultPropsProvider-vuOrHUjA.js";import"./useSlot-C-9D5Kty.js";import"./table-CcRwBaKs.js";import"./search-B3u_YPwK.js";import"./house-CssJoYi9.js";function je({isOpen:o,setIsOpen:x,customerData:u}){const[f,g]=r.useState("cash"),[P,S]=r.useState(0),[i,h]=r.useState(0),[j,N]=r.useState(""),[m,I]=r.useState(""),[b,c]=r.useState(1),R=L(),C=F({mutationFn:a=>Y(a),onSuccess:()=>{y.success("تم إضافة الدفعة بنجاح!"),h(0),N(""),I(""),c(1),x(!1),R.invalidateQueries({queryKey:["customer-details"]})},onError:a=>{console.error(a),y.error("حدث خطأ أثناء إضافة الدفعة")}});return e.jsx(w,{title:"اضافة دفعة",trigger:e.jsx(d,{onClick:a=>{x(!0),a.stopPropagation()},variant:"accent",size:"sm",className:"w-full",children:"اضافة دفعة من الزبون"}),isOpen:o,setIsOpen:x,children:e.jsxs("form",{className:"space-y-4 mt-4",onSubmit:a=>{a.preventDefault(),C.mutate({customerId:u.id,amount:m=="USD"?i:Number((i/b).toFixed(1)),note:j,currency:m,exchangeRate:b,amount_base:i})},children:[e.jsx(p,{label:"قيمة الدفعة",id:"payment-amount",type:"number",value:i.toString(),onChange:a=>h(Number(a.target.value))}),e.jsx(p,{label:"ملاحظات",id:"note",type:"text",value:j,onChange:a=>N(a.target.value)}),f!="debt"&&e.jsxs(e.Fragment,{children:[" ",e.jsxs(ne,{value:m,onValueChange:I,children:[e.jsx(M,{className:"w-full mt-6",children:e.jsx(z,{placeholder:"العملة المدفوع بها"})}),e.jsx(B,{children:["SYP","USD"].map(a=>e.jsx(J,{value:a,children:a},a))})]}),e.jsx(p,{id:"exchangeRate",label:"سعر الصرف",value:m=="USD"?1:b,onChange:a=>c(Number(a.target.value)),disabled:m==="USD"})]}),e.jsx(d,{className:"w-full",type:"submit",children:"اضافة دفعة"})]})})}const k=o=>{if(!o)return 0;if(!isNaN(Number(o)))return Number(o);const x=new Date(o);if(!isNaN(x.getTime()))return x.getTime();if(o.includes(",")&&o.includes("/")){const[u,f]=o.split(","),[g,P,S]=u.split(":").map(Number),[i,h,j]=f.split("/").map(Number);return new Date(j,h-1,i,g,P,S).getTime()}return 0};function Ue(){const o=se(),u=ae().state,[f,g]=r.useState(!1),[P,S]=r.useState(!1),[i,h]=r.useState(0),[j,N]=r.useState(""),m=L(),[I,b]=r.useState(null),[c,R]=r.useState({}),[C,a]=r.useState("cash"),[T,_]=r.useState(0),[A,$]=r.useState(""),[v,E]=r.useState(""),[q,V]=r.useState(1),H=F({mutationFn:t=>Y(t),onSuccess:()=>{y.success("تم إضافة الدفعة بنجاح!"),h(0),N(""),E(""),V(1),S(!1),g(!1),m.invalidateQueries({queryKey:["customer-details"]})},onError:t=>{console.error(t),y.error("حدث خطأ أثناء إضافة الدفعة")}}),G=F({mutationFn:t=>oe(t),onSuccess:()=>{m.invalidateQueries({queryKey:["customer-details"]})},onError:t=>{console.error(t),y.error("حدث خطأ أثناء الإرجاع")}}),[W,U]=r.useState({}),{data:l,isLoading:X}=re({queryKey:["customer-details",u],queryFn:()=>xe(u),enabled:!!u});r.useEffect(()=>{l!=null&&l.data&&U(l.data)},[l]);const Z=[{label:"المعرف",key:"id",hidden:!0},{label:"المبلغ",key:"amount"},{label:"الوصف",key:"note"},{label:"التاريخ",key:"date"}],ee=[{label:"المعرف",key:"id",hidden:!0},{label:"السعر النهائي",key:"totalPrice"},{label:"المنتجات",key:"productsString"},{label:"التاريخ",key:"date"}];return e.jsx(me,{children:e.jsxs("div",{className:"space-y-6",dir:"rtl",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h1",{className:"text-3xl font-bold",children:"بيانات الزبون"}),e.jsxs(d,{onClick:()=>o(-1),variant:"outline",children:[e.jsx(he,{className:"ml-2 w-4 h-4"})," رجوع"]})]}),e.jsxs(Q,{children:[e.jsx(ie,{children:e.jsx(pe,{children:"المعلومات الأساسية"})}),e.jsxs(K,{className:"grid grid-cols-1 gap-4",children:[e.jsx(ue,{customer:W,setCustomer:U}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(je,{isOpen:P,setIsOpen:S,customerData:u}),e.jsx(w,{title:"دفع للزبون",trigger:e.jsx(d,{onClick:t=>{g(!0),t.stopPropagation()},variant:"destructive",size:"sm",className:"w-full",children:"دفع للزبون"}),isOpen:f,setIsOpen:g,children:e.jsxs("form",{className:"space-y-4 mt-4",onSubmit:t=>{t.preventDefault(),H.mutate({customerId:u.id,amount:v=="USD"?-i:-Number((i/q).toFixed(1)),note:j,currency:v,exchangeRate:q,amount_base:-i})},children:[e.jsx(p,{label:"قيمة الدفعة",id:"payment-amount",type:"number",value:i.toString(),onChange:t=>h(Number(t.target.value))}),e.jsx(p,{label:"ملاحظات",id:"note",type:"text",value:j,onChange:t=>N(t.target.value)}),C!="debt"&&e.jsxs(e.Fragment,{children:[" ",e.jsxs(le,{value:v,onValueChange:E,children:[e.jsx(M,{className:"w-full mt-6",children:e.jsx(z,{placeholder:"العملة المدفوع بها"})}),e.jsx(B,{children:["SYP","USD"].map(t=>e.jsx(J,{value:t,children:t},t))})]}),e.jsx(p,{id:"exchangeRate",label:"سعر الصرف",value:v=="USD"?1:q,onChange:t=>V(Number(t.target.value)),disabled:v==="USD"})]}),e.jsx(d,{className:"w-full",type:"submit",children:"اضافة دفعة"})]})})]})]})]}),e.jsx(Q,{className:"overflow-x-auto",children:X?e.jsx(ce,{className:"h-48 w-full"}):l!=null&&l.data?e.jsxs(K,{className:"space-y-4 md:space-y-0 grid grid-cols-1 gap-4",children:[e.jsx(O,{title:"الدفعات",columns:Z,data:[...(l==null?void 0:l.data.payments)??[]].sort((t,s)=>k(s.date)-k(t.date))}),e.jsx(O,{title:"عمليات الشراء",columns:ee,data:l?l.data.purchases.filter(t=>Array.isArray(t.products)&&t.products.length>0).map(t=>({...t,productsString:t.products.map(s=>s.name).join(", ")})).sort((t,s)=>k(s.date)-k(t.date)):[],renderRowActions:t=>e.jsxs("div",{className:"flex gap-2",children:[e.jsx(d,{variant:"outline",onClick:()=>{o("/sellDetails",{state:t.id})},children:"تفاصيل"}),e.jsx(w,{title:"إرجاع منتجات الفاتورة",isOpen:I===t.id,setIsOpen:()=>b(null),trigger:e.jsx(d,{onClick:s=>{s.stopPropagation(),b(t.id)},children:"إرجاع"}),children:e.jsxs("form",{className:"space-y-4",onSubmit:s=>{s.preventDefault(),t.products.filter(n=>(Number(c[n.id])||0)>0).map(n=>({productId:n.id,productCode:n.code,customerId:t.customerId,warehouse:n.warehouse,qty:-Number(c[n.id]),returnValue:Number(c[n.id])*n.sellPrice,referenceId:t.id,partValue:T,returnType:C,reason:A})).forEach(n=>{console.log(n),G.mutate(n)}),y.success("تم تسجيل الإرجاع بنجاح!"),b(null),R({})},children:[e.jsx("div",{className:"max-h-96 overflow-y-auto mt-4 border-2 rounded-md ",children:t.products.map(s=>e.jsxs("div",{className:"border p-2 rounded-md",children:[e.jsx("p",{className:"font-semibold",children:s.name}),e.jsxs("p",{children:["الكمية الأصلية: ",s.qty]}),e.jsxs("p",{children:["سعر الوحدة: ",s.sellPrice]}),e.jsxs("p",{children:["المستودع: ",s.warehouse]}),e.jsx(p,{id:`return-${s.id}`,label:"كمية الإرجاع",value:(c[s.id]||0).toString(),onChange:D=>{let n=D.target.value;n>s.qty&&(n=s.qty),R(te=>({...te,[s.id]:n}))}}),e.jsxs("p",{children:["المبلغ:"," ",(Number(c[s.id])||0)*s.sellPrice]})]},s.id))}),e.jsxs("p",{className:"font-bold",children:["المجموع الكلي:"," ",t.products.reduce((s,D)=>s+(Number(c[D.id])||0)*D.sellPrice,0)]}),e.jsx(de,{value:C,onChange:a,partValue:T,onPartValueChange:s=>_(s)}),e.jsx(p,{id:"return-reason",label:"ملاحظات",type:"text",value:A,onChange:s=>{$(s.target.value)}}),e.jsx(d,{type:"submit",className:"w-full",children:"تأكيد الإرجاع"})]})})]})})]}):e.jsx("p",{className:"text-muted-foreground text-center",children:"لا توجد معاملات حالياً."})})]})})}export{Ue as default};
