import{r as l,u as U,a as E,j as e,B as b,b as A,c as Y,d as $,D as Z,g as z}from"./index-DKD6fGdY.js";import{D as G}from"./DataTable-BNRowHBq.js";import{P as Q,F as o,S as H,a as V,b as w,c as M,d as B,e as X}from"./FormInput-BGYzTtk9.js";import{p as ee,h as te}from"./transaction-CfMUQGRI.js";import{S as ae}from"./SupplierSelect-DX4n1qEW.js";import{P as se}from"./PaymentTypeSelector-Cb3CKIHT.js";import"./input-B387beSv.js";import"./supplier-Bs52lWPF.js";function re({isOpen:n,setIsOpen:N,row:i}){const[x,C]=l.useState(!1),[a,c]=l.useState(""),[p,g]=l.useState(""),[d,j]=l.useState(""),[h,y]=l.useState(""),[u,S]=l.useState("0"),[v,t]=l.useState("0"),[r,P]=l.useState("0"),[q,k]=l.useState(""),[m,D]=l.useState("cash"),[F,J]=l.useState("0"),[O,I]=l.useState(""),[f,T]=l.useState(""),[R,W]=l.useState(1),K=U();l.useEffect(()=>{i&&(c(i.name),g(i.code),j(i.category),y(i.warehouse),S(i.payPrice),t(i.sellPrice),k(i.unit))},[i]);const L=E({mutationFn:s=>ee(s),onSuccess:()=>{alert("تم إضافة المنتج بنجاح!"),c(""),g(""),j(""),y(""),S("0"),t("0"),k(""),P("0"),D("cash"),I(""),N(!1),K.invalidateQueries({queryKey:["products-table"]})},onError:s=>{console.error(s),alert("حدث خطأ أثناء إضافة المنتج")}}),_=async s=>{if(s.preventDefault(),!a||!p||!d||!h||!u||!v||!q||!r){alert("الرجاء التأكد من البيانات");return}if(!O){alert("الرجاء اختيار المورد");return}if(m!=="debt"&&!f){alert("الرجاء اختيار العملة");return}if(m==="part"&&Number(F)<=0){alert("الرجاء ادخال قيمة الدفعة الجزئية");return}if(m!=="debt"&&f==="SYP"&&R<=0){alert("الرجاء ادخال سعر صرف صحيح");return}if(m==="part"&&Number(F)>=Number(r)*Number(u)){alert("قيمة الدفعة الجزئية لا يمكن ان تكون اكبر من او تساوي المبلغ الكلي");return}L.mutate({newProduct:{name:a,code:p,category:d,warehouse:h,payPrice:Number(u),sellPrice:Number(v),unit:q,quantity:Number(r)},newPurchase:{supplierId:O,name:a,code:p,warehouse:h,quantity:Number(r),payPrice:Number(u),currency:f,exchangeRate:R,amount_base:Number(u)*R,totalPrice:Number(r)*Number(u),paymentStatus:"pending",remainingDebt:m=="debt"?Number(r)*Number(u):m=="cash"?0:Number(r)*Number(u)-(f=="USD"?Number(u):Number((Number(F)/R).toFixed(1)))}}),c(""),g(""),j(""),y(""),S("0"),t("0"),k(""),P("0"),D("cash"),I(""),T("USD"),W(1)};return e.jsx("div",{children:e.jsx(Q,{title:"شراء منتجات",isOpen:n,setIsOpen:N,trigger:e.jsx(e.Fragment,{}),children:e.jsxs("form",{dir:"rtl",onSubmit:_,className:"grid grid-cols-2 gap-3",children:[e.jsx(o,{id:"productName",label:"اسم المنتج",value:a,onChange:s=>c(s.target.value)}),e.jsx(o,{id:"RMZProduct",label:"رمز المنتج",value:p,onChange:s=>g(s.target.value)}),e.jsx(o,{id:"productCategory",label:"الصنف",value:d,onChange:s=>j(s.target.value)}),e.jsx(o,{id:"invId",label:"المستودع",value:h,onChange:s=>y(s.target.value)}),e.jsx(o,{id:"payPrice",label:"سعر الشراء",value:u,onChange:s=>S(s.target.value)}),e.jsx(o,{id:"sellPrice",label:"سعر المبيع",value:v,onChange:s=>t(s.target.value)}),e.jsx(o,{id:"quantity",label:"الكمية",value:r,onChange:s=>P(s.target.value)}),e.jsx(o,{id:"unit",label:"الواحدة",value:q,onChange:s=>k(s.target.value)}),e.jsxs("div",{className:"col-span-2 grid grid-cols-3 gap-2",children:[e.jsx(b,{onClick:()=>{D("cash")},className:"col-span-1",variant:m==="cash"?"default":"outline",type:"button",children:"نقدا"}),e.jsx(b,{onClick:()=>{D("part")},className:"col-span-1",variant:m==="part"?"default":"outline",type:"button",children:"جزئي"}),e.jsx(b,{onClick:()=>{D("debt")},className:"col-span-1",variant:m==="debt"?"default":"outline",type:"button",children:"دين"})]}),m==="part"&&e.jsx(o,{id:"partPayment",label:"قيمة الدفعة",value:F,onChange:s=>J(s.target.value)}),m!="debt"&&e.jsxs(e.Fragment,{children:[e.jsxs(H,{value:f,onValueChange:T,children:[e.jsx(V,{className:"w-full mt-6",children:e.jsx(w,{placeholder:"العملة المدفوع بها"})}),e.jsx(M,{children:["SYP","USD"].map(s=>e.jsx(B,{value:s,children:s},s))})]}),e.jsx(o,{id:"exchangeRate",label:"سعر الصرف",value:f=="USD"?1:R,onChange:s=>W(Number(s.target.value)),disabled:f==="USD"})]}),e.jsx(ae,{className:"mt-6",isOpen:x,setIsOpen:C,supplierId:O,setSupplierId:I,withDataTable:!0}),e.jsx(b,{className:"col-span-2",type:"submit",children:"اضافة"})]})})})}function ne({row:n,isOpen:N,setIsOpen:i}){const{data:x,isLoading:C}=A(),[a,c]=l.useState({productId:n.id,code:n.code,name:n.name,warehouse:"",oldWarehouse:n.warehouse,category:n.category,unit:n.unit,quantity:0,sellPrice:n.sellPrice,note:"",exchangeRate:0,amount_base:0,amount:0,currency:"USD"}),[p,g]=l.useState("cash"),[d,j]=l.useState(0),h=U(),y=E({mutationFn:t=>te(t),onSuccess:()=>{i(!1),h.invalidateQueries({queryKey:["products-table"]}),h.invalidateQueries({queryKey:["warehouses-table"]})},onError:t=>{console.error(t),alert("حدث خطأ أثناء إضافة الزبون")}});l.useEffect(()=>{n&&c({productId:n.id,code:n.code,name:n.name,warehouse:"",oldWarehouse:n.warehouse,category:n.category,unit:n.unit,quantity:0,sellPrice:n.sellPrice,note:"",exchangeRate:0,amount_base:0,amount:0,currency:"USD"})},[n]);const u=(t,r)=>{c(P=>({...P,[t]:r}))},S=t=>{t.preventDefault(),c(r=>({...r,quantity:n.quantity}))},v=t=>{if(t.preventDefault(),a.quantity<=0||a.quantity>n.quantity){alert("الرجاء ادخال كمية صحيحة للنقل");return}if(a.warehouse===""){alert("الرجاء اختيار المستودع المنقول إليه");return}if(a.amount<0){alert("الرجاء ادخال تكلفة نقل صحيحة");return}if(a.currency===""){alert("الرجاء اختيار العملة المدفوع بها");return}if(a.sellPrice<=0){alert("الرجاء ادخال سعر مبيع صحيح");return}if(p==="part"&&d<=0){alert("الرجاء ادخال قيمة الدفعة الجزئية");return}if(p==="part"&&d>=a.amount){alert("قيمة الدفعة الجزئية لا يمكن ان تكون اكبر من او تساوي المبلغ الكلي");return}try{y.mutate({productId:a.productId,oldWarehouse:a.oldWarehouse,newWarehouse:a.warehouse,exchangeRate:a.exchangeRate,amount_base:a.amount,amount:a.amount,currency:a.currency,quantity:a.quantity,note:a.note,newSellPrice:a.sellPrice})}catch(r){alert("حدث خطأ أثناء نقل المنتج"),console.error(r)}};return e.jsx(Q,{isOpen:N,setIsOpen:i,trigger:e.jsx(e.Fragment,{}),title:"نقل منتج",children:e.jsx("form",{onSubmit:v,children:e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(o,{label:"اسم المنتج",disabled:!0,value:a==null?void 0:a.name}),e.jsx(o,{label:"صنف المنتج",disabled:!0,value:a==null?void 0:a.category}),e.jsx(o,{label:"الواحدة",disabled:!0,value:a==null?void 0:a.unit}),e.jsx(o,{label:"المستودع القديم",disabled:!0,value:n.warehouse}),e.jsxs("div",{className:"flex",children:[e.jsx(o,{type:"number",id:"prodQuantity",label:"الكمية المراد نقلها",value:a.quantity,onChange:t=>u("quantity",Number(t.target.value))}),e.jsx(b,{type:"button",className:"mt-6 rounded-r-none",onClick:S,children:n.quantity})]}),e.jsx(o,{type:"number",id:"prodSellPrice",label:"سعر المبيع",value:a.sellPrice,onChange:t=>u("sellPrice",Number(t.target.value))}),e.jsx(o,{disabled:C,id:"prodNewWarehouse",label:"المستودع المنقول إليه",value:a.warehouse,options:x==null?void 0:x.map((t,r)=>({id:t,name:t})),onChange:t=>{console.log(t),u("warehouse",t)}}),a.warehouse=="other"?e.jsx(o,{id:"prodNewWarehouse",label:"المستودع المنقول إليه",onBlur:t=>{t.target.value!==""&&(x.push(t.target.value),u("warehouse",""))}}):e.jsx(e.Fragment,{}),e.jsxs("div",{className:`${a.warehouse=="other"?"col-span-2":"col-span-1"} grid grid-cols-3`,children:[e.jsx("div",{className:"col-span-2",children:e.jsx(o,{id:"prodTransfareCost",label:"تكلفة النقل",value:a.amount,onChange:t=>u("amount",t.target.value)})}),e.jsxs(X,{value:a.currency,onValueChange:t=>u("currency",t),children:[e.jsx(V,{className:"mt-6",children:e.jsx(w,{placeholder:"العملة المدفوع بها"})}),e.jsx(M,{children:["SYP","USD"].map(t=>e.jsx(B,{value:t,children:t},t))})]})]}),e.jsx("div",{className:"col-span-2",children:e.jsx(se,{value:p,onChange:g,partValue:d,onPartValueChange:t=>j(t)})}),e.jsx("div",{className:"col-span-2",children:e.jsx(o,{id:"transferNote",label:"ملاحظات النقل",value:a.note,onChange:t=>u("note",t.target.value)})}),e.jsx(b,{type:"submit",className:"col-span-2",disabled:y.isPending,children:y.isPending?"جاري النقل...":"تأكيد"})]})})})}function he(){const n=Y(),[N,i]=l.useState(!1),[x,C]=l.useState({}),[a,c]=l.useState(!1),[p,g]=l.useState(null),[d,j]=l.useState([]),{data:h,isLoading:y}=$({queryKey:["products-table"],queryFn:z}),u=[{key:"id",label:"المعرف",sortable:!0,hidden:!0},{key:"code",label:"الرمز",sortable:!0},{key:"name",label:"الاسم",sortable:!0},{key:"quantity",label:"الكمية",sortable:!0},{key:"warehouse",label:"المخزن",sortable:!0},{key:"sellPrice",label:"سعر المبيع",sortable:!0},{key:"category",label:"الصنف",sortable:!0},{key:"unit",label:"الواحدة",sortable:!0}],S=t=>d.some(r=>JSON.stringify(r)===JSON.stringify(t)),v=t=>{j(r=>S(t)?r.filter(q=>JSON.stringify(q)!==JSON.stringify(t)):[...r,t])};return e.jsx(Z,{children:e.jsxs("div",{children:[e.jsx(re,{isOpen:a,setIsOpen:c,row:p}),e.jsx(ne,{isOpen:N,setIsOpen:i,row:x}),e.jsx(G,{title:"قائمة المنتجات",titleButton:e.jsx(b,{onClick:()=>{g(null),c(!0)},children:"إضافة منتج"}),columns:u,data:h?Object.values(h||{}).flatMap(t=>Object.values(t)):[],onRowClick:t=>v(t),getRowClassName:t=>d!=null&&d.some(r=>r===t)?"bg-green-50 hover:bg-green-100":"",renderRowActions:t=>e.jsxs("div",{className:"flex gap-1",children:[e.jsx(b,{variant:"default",onClick:r=>{r.stopPropagation(),g(t),c(!0)},children:"شراء"}),e.jsx(b,{variant:"outline",onClick:r=>{r.stopPropagation(),n("/productDetails",{state:t})},children:"التفاصيل"}),e.jsx(b,{variant:"secondary",onClick:r=>{r.stopPropagation(),C(t),i(!0)},children:"نقل"})]})})]})})}export{he as default};
