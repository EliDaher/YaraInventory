import{m as ae,a0 as se,r as l,h as le,f as ne,j as e,D as re,B as o}from"./index-B37bWIRV.js";import{C as ie,D as oe,S as ue}from"./Skeleton-CSvQh00m.js";import{D as V}from"./DataTable-CS_HJ6iR.js";import{P as ce}from"./PaymentTypeSelector-BXCRKwWU.js";import{C as A,b as de}from"./card-DLYYdMtX.js";import{P as b,F as i,S as E,a as L,b as Q,c as B,d as K}from"./FormInput-DNrUytQP.js";import{a as me}from"./supplier-BeaCGAtK.js";import{a as pe,b as xe}from"./transaction-D5xCwmjf.js";import{u as M}from"./badge-CkJbfXe2.js";import{A as he}from"./arrow-left-BHknfJeO.js";import{C as z}from"./CardContent-B8FJP5Zj.js";import"./customer-CBPUnZWG.js";import"./DefaultPropsProvider-CeodWBsc.js";import"./useSlot-DsOrKOoN.js";import"./table-C05-iM26.js";import"./input-BzYCNeo2.js";import"./search-iA-z61xT.js";function Ue(){var w,O,F,U;const Y=ae(),u=se().state,[_,x]=l.useState(!1),[$,f]=l.useState(!1),[d,S]=l.useState(""),[r,h]=l.useState(""),[m,y]=l.useState(""),[v,H]=l.useState("cash"),[N,G]=l.useState(0),[C,J]=l.useState(""),[n,D]=l.useState(""),[c,P]=l.useState(1),[k,g]=l.useState(null),I=le(),[W,R]=l.useState({}),{data:s,isLoading:X}=ne({queryKey:["supplier-details",u],queryFn:()=>me(u),enabled:!!u});l.useEffect(()=>{s!=null&&s.data&&R(s.data)},[s]);const q=M({mutationFn:t=>pe(t),onSuccess:()=>{alert("تم إضافة الدفعة بنجاح!"),h(""),y(""),x(!1),f(!1),I.invalidateQueries({queryKey:["supplier-details"]})},onError:t=>{console.error(t),alert("حدث خطأ أثناء إضافة المنتج")}}),j=M({mutationFn:t=>xe(t),onSuccess:()=>{alert("تم الارجاع بنجاح!"),S(""),g(null),I.invalidateQueries({queryKey:["supplier-details"]})},onError:t=>{console.error(t),alert("حدث خطأ أثناء ارجاع المنتج")}}),Z=[{label:"المعرف",key:"id",hidden:!0},{label:"المبلغ",key:"amount"},{label:"الوصف",key:"note"},{label:"التاريخ",key:"date"}],ee=[{label:"المعرف",key:"id",hidden:!0},{label:"كود المادة",key:"code"},{label:"اسم المادة",key:"name"},{label:"الكمية",key:"quantity"},{label:"المستودع",key:"warehouse"},{label:"السعر النهائي",key:"totalPrice"},{label:"التاريخ",key:"date"}],te=async(t,a)=>{var T;t.preventDefault();try{const p={productCode:a.code,supplierId:u.id,warehouse:a.warehouse,qty:-Number(d),returnType:v,returnValue:Number(d)*a.payPrice,referenceId:a.id,productId:a.id,partValue:N,reason:C};j.mutate(p)}catch(p){console.error("❌ خطأ أثناء الإرجاع:",((T=p.response)==null?void 0:T.data)||p.message)}};return e.jsx(re,{children:e.jsxs("div",{className:"space-y-6",dir:"rtl",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h1",{className:"text-3xl font-bold",children:"بيانات المورد"}),e.jsxs(o,{onClick:()=>Y(-1),variant:"outline",children:[e.jsx(he,{className:"ml-2 w-4 h-4"})," رجوع"]})]}),e.jsxs(A,{children:[e.jsx(ie,{children:e.jsx(de,{children:"المعلومات الأساسية"})}),e.jsxs(z,{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(oe,{customer:W,setCustomer:R,isSupplier:!0}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(b,{title:"دفعة من المورد",trigger:e.jsx(o,{className:"w-full",onClick:t=>{x(!0),t.stopPropagation()},variant:"accent",size:"sm",children:"دفعة من المورد"}),isOpen:_,setIsOpen:x,children:e.jsxs("form",{className:"space-y-4 mt-4",onSubmit:t=>{t.preventDefault(),q.mutate({supplierId:u,amount:n=="USD"?r:Number((Number(r)/c).toFixed(1)),note:m,currency:n,exchangeRate:c,amount_base:r})},children:[e.jsx(i,{label:"قيمة الدفعة",id:"payment-amount",type:"text",value:r,onChange:t=>h(t.target.value)}),e.jsx(i,{label:"ملاحظات",id:"note",type:"text",value:m,onChange:t=>y(t.target.value)}),e.jsxs(E,{value:n,onValueChange:D,children:[e.jsx(L,{className:"w-full mt-6",children:e.jsx(Q,{placeholder:"العملة المدفوع بها"})}),e.jsx(B,{children:["SYP","USD"].map(t=>e.jsx(K,{value:t,children:t},t))})]}),e.jsx(i,{id:"exchangeRate",label:"سعر الصرف",value:n=="USD"?1:c,onChange:t=>P(Number(t.target.value)),disabled:n==="USD"}),e.jsx(o,{className:"w-full",type:"submit",children:"دفع للمورد"})]})}),e.jsx(b,{title:"دفع للمورد",trigger:e.jsx(o,{className:"w-full",variant:"destructive",size:"sm",children:"دفع للمورد"}),isOpen:$,setIsOpen:f,children:e.jsxs("form",{className:"space-y-4 mt-4",onSubmit:t=>{t.preventDefault(),q.mutate({supplierId:u,amount:n=="USD"?-r:-Number((Number(r)/c).toFixed(1)),note:m,currency:n,exchangeRate:c,amount_base:-r})},children:[e.jsx(i,{label:"قيمة الدفعة",id:"payment-amount",type:"text",value:r,onChange:t=>h(t.target.value)}),e.jsx(i,{label:"ملاحظات",id:"note",type:"text",value:m,onChange:t=>y(t.target.value)}),e.jsxs(E,{value:n,onValueChange:D,children:[e.jsx(L,{className:"w-full mt-6",children:e.jsx(Q,{placeholder:"العملة المدفوع بها"})}),e.jsx(B,{children:["SYP","USD"].map(t=>e.jsx(K,{value:t,children:t},t))})]}),e.jsx(i,{id:"exchangeRate",label:"سعر الصرف",value:n=="USD"?1:c,onChange:t=>P(Number(t.target.value)),disabled:n==="USD"}),e.jsx(o,{className:"w-full",type:"submit",children:"دفع للمورد"})]})})]})]})]}),e.jsx(A,{className:"overflow-x-auto",children:X?e.jsx(ue,{className:"h-48 w-full"}):!((O=(w=s==null?void 0:s.data)==null?void 0:w.payments)!=null&&O.length)&&!((U=(F=s==null?void 0:s.data)==null?void 0:F.purchases)!=null&&U.length)?e.jsx("p",{className:"text-muted-foreground text-center",children:"لا توجد معاملات حالياً."}):e.jsxs(z,{className:"space-y-4 md:space-y-0 grid md:grid-cols-2 gap-4",children:[e.jsx(V,{title:"الدفعات",columns:Z,data:s.data.payments,getRowClassName:t=>t.type!=="income"?"text-red-500":"text-green-500"}),e.jsx(V,{title:"عمليات الشراء",columns:ee,data:s.data.purchases,renderRowActions:t=>e.jsx(b,{title:`إرجاع منتج: ${t.code} - ${t.name||""}`,isOpen:k===t.id.toString(),setIsOpen:()=>g(null),trigger:e.jsx(o,{onClick:a=>{a.preventDefault(),a.stopPropagation(),g(t.id.toString()),console.log("row id:",k)},children:"إرجاع"}),children:e.jsxs("form",{onSubmit:a=>te(a,t),className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(i,{label:"الكمية",id:"return-quantity",type:"number",value:d,onChange:a=>S(a.target.value)}),e.jsxs("p",{className:"text-sm text-gray-500",children:["الكمية الأصلية: ",t.quantity,e.jsx("br",{}),"سعر الواحدة: ",t.payPrice]})]}),e.jsxs("p",{className:"font-semibold",children:["المبلغ الإجمالي: ",t.payPrice*Number(d)]}),e.jsx(ce,{value:v,onChange:H,partValue:N,onPartValueChange:a=>G(a)}),e.jsx(i,{id:"return-reason",label:"ملاحظات",type:"text",value:C,onChange:a=>J(a.target.value)}),e.jsx("div",{className:"flex justify-end mt-2",children:e.jsx(o,{type:"submit",className:"w-full",disabled:j.isPending,children:j.isPending?"جاري التأكيد...":"تأكيد الإرجاع"})})]})})})]})})]})})}export{Ue as default};
