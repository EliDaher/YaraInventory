import{r as l,j as e,B as N,X as E,R as V,u as J,a as M,c as q,D as Q,C as U,k as B,l as K}from"./index-BLsygcWL.js";import{C as T}from"./AddCustomerForm-BAsO_shB.js";import{D as $}from"./DataTable-ByGNN8Jd.js";import{I as P}from"./input-DKh37XK_.js";import{F as v}from"./FormInput-D3m7K6hd.js";import{e as z,a as H,b as X,c as Y,d as _}from"./select-D98sX2JZ.js";import{g as G}from"./customer-QfQvx3Vo.js";import{g as W}from"./products-FYWWqLP8.js";import{s as Z}from"./transaction-DnjL-qa2.js";const ee=({products:b,onChange:x,setAmount:C})=>{const[u,j]=l.useState(""),[o,m]=l.useState([]),g=l.useMemo(()=>b.filter(t=>t.name.toLowerCase().includes(u.toLowerCase())||t.code.toLowerCase().includes(u.toLowerCase())),[b,u]),h=t=>{const a=o.find(r=>r.id===t.id);if(a)p(t.id,a.qty+1);else{const r=[...o,{...t,qty:1}];m(r),x(r)}},p=(t,a)=>{var d;if(a>((d=b.find(c=>c.id===t))==null?void 0:d.quantity)){alert("الكمية المطلوبة غير متوفرة في المخزون");return}const r=o.map(c=>c.id===t?{...c,qty:a}:c).filter(c=>c.qty>=0);m(r),x(r)},i=(t,a)=>{const r=o.map(d=>d.id===t?{...d,sellPrice:a}:d).filter(d=>d.qty>=0);m(r),x(r)},S=t=>{const a=o.filter(r=>r.id!==t);m(a),x(a)},n=o.reduce((t,a)=>t+a.sellPrice*a.qty,0);return l.useEffect(()=>{C(n)},[n]),e.jsxs("div",{className:"p-4 bg-white rounded-lg shadow",children:[e.jsx("h3",{className:"text-lg font-bold mb-2",children:"اختيار المنتجات"}),e.jsx(P,{placeholder:"ابحث عن المنتج بالاسم أو الكود...",value:u,onChange:t=>j(t.target.value),className:"mb-2"}),u&&g.length>0&&e.jsx("div",{className:"max-h-40 overflow-y-auto border p-2 rounded mb-4",children:g.map(t=>e.jsxs("div",{className:"flex justify-between items-center p-1 hover:bg-gray-100 cursor-pointer",onClick:()=>h(t),children:[e.jsxs("span",{children:[t.name," (",t.code,") - $",t.sellPrice]}),e.jsxs("span",{children:["المخزون: ",t.quantity]})]},t.id))}),o.length>0&&e.jsxs("table",{className:"w-full border-collapse",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"border p-1",children:"المنتج"}),e.jsx("th",{className:"border p-1",children:"الكود"}),e.jsx("th",{className:"border p-1",children:"السعر"}),e.jsx("th",{className:"border p-1",children:"الكمية"}),e.jsx("th",{className:"border p-1",children:"المجموع"}),e.jsx("th",{className:"border p-1",children:"حذف"})]})}),e.jsxs("tbody",{children:[o.map(t=>e.jsxs("tr",{children:[e.jsx("td",{className:"border p-1",children:t.name}),e.jsx("td",{className:"border p-1",children:t.code}),e.jsx("td",{className:"border p-1",children:e.jsx(P,{type:"number",min:0,value:t.sellPrice,onChange:a=>i(t.id,Number(a.target.value)),className:"w-16"})}),e.jsx("td",{className:"border p-1",children:e.jsx(P,{type:"number",min:1,value:t.qty,onChange:a=>p(t.id,Number(a.target.value)),className:"w-16"})}),e.jsxs("td",{className:"border p-1",children:["$",(t.sellPrice*t.qty).toFixed(2)]}),e.jsx("td",{className:"border p-1 text-center",children:e.jsx(N,{variant:"destructive",size:"sm",onClick:()=>S(t.id),children:e.jsx(E,{})})})]},t.id)),e.jsxs("tr",{children:[e.jsx("td",{colSpan:4,className:"border p-1 font-bold text-right",children:"الإجمالي"}),e.jsxs("td",{colSpan:2,className:"border p-1 font-bold",children:["$",n.toFixed(2)]})]})]})]})]})};function he(){const[b,x]=V.useState(!1),[C,u]=l.useState([]),[j,o]=l.useState(""),[m,g]=l.useState(""),[h,p]=l.useState(0),[i,S]=l.useState([]),[n,t]=l.useState("cash"),[a,r]=l.useState(""),d=J(),[c,D]=l.useState(""),[y,k]=l.useState(1),F=M({mutationFn:s=>Z({newSell:s}),onSuccess:()=>{alert("تم بيع المنتج بنجاح!"),u([]),o(""),g(""),p(0),S([]),t("cash"),r(""),d.invalidateQueries({queryKey:["sells-table"]})},onError:s=>{console.error(s),alert("حدث خطأ أثناء بيع المنتج")}}),R=s=>i.some(f=>JSON.stringify(f)===JSON.stringify(s)),L=s=>{S(f=>R(s)?f.filter(A=>JSON.stringify(A)!==JSON.stringify(s)):[s])},{data:w,isLoading:te}=q({queryKey:["products-table"],queryFn:W});l.useEffect(()=>{p(Number((Number(m)-Number(j)).toFixed(3)))},[j,m]);const{data:O,isLoading:se}=q({queryKey:["customers-table"],queryFn:G}),I=[{key:"id",label:"الرمز",sortable:!0,hidden:!0},{key:"name",label:"الاسم",sortable:!0},{key:"number",label:"الرقم",sortable:!0}];return e.jsx(Q,{children:e.jsxs(U,{children:[e.jsx(B,{children:e.jsx("h1",{className:"text-2xl font-bold",children:"بيع المنتجات"})}),e.jsxs(K,{className:"grid grid-cols-1 md:grid-cols-3 gap-2",children:[e.jsx("div",{className:"md:col-span-1",children:e.jsx($,{title:"الزبائن",titleButton:e.jsx(T,{isOpen:b,setIsOpen:x,className:"w-full mb-2"}),columns:I||[],data:O||[],onRowClick:s=>L(s),getRowClassName:s=>i!=null&&i.some(f=>f===s)?"bg-green-50 hover:bg-green-100":""})}),e.jsx("div",{className:"md:col-span-2",children:e.jsx(ee,{products:w?Object.values(w||{}).flatMap(s=>Object.values(s)):[],setAmount:g,onChange:s=>u(s)})}),e.jsxs("form",{className:"md:col-span-3 mt-8 grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsx(v,{label:"الحسم",id:"discount-amount",type:"text",value:j,onChange:s=>o(s.target.value)}),e.jsx(v,{label:"السعر النهائي",id:"discount-amount",type:"text",value:h.toString(),onChange:s=>{}}),e.jsxs("div",{className:"grid grid-cols-3 gap-2 md:col-span-2",children:[e.jsx(N,{onClick:()=>{t("cash")},className:"col-span-1",variant:n==="cash"?"default":"outline",type:"button",children:"نقدا"}),e.jsx(N,{onClick:()=>{t("part")},className:"col-span-1",variant:n==="part"?"default":"outline",type:"button",children:"جزئي"}),e.jsx(N,{onClick:()=>{t("debt")},className:"col-span-1",variant:n==="debt"?"default":"outline",type:"button",children:"دين"})]}),n==="part"&&e.jsx(v,{id:"partPayment",label:"قيمة الدفعة",value:a.toString(),onChange:s=>r(s.target.value)}),n!="debt"&&e.jsxs(e.Fragment,{children:[" ",e.jsxs(z,{value:c,onValueChange:D,children:[e.jsx(H,{className:"w-full mt-6",children:e.jsx(X,{placeholder:"العملة المدفوع بها"})}),e.jsx(Y,{children:["SYP","USD"].map(s=>e.jsx(_,{value:s,children:s},s))})]}),e.jsx(v,{id:"exchangeRate",label:"سعر الصرف",value:c=="USD"?1:y,onChange:s=>k(Number(s.target.value)),disabled:c==="USD"})]}),e.jsx(N,{className:"w-full md:col-span-2",variant:"accent",onClick:s=>{if(s.preventDefault(),i.length<=0){alert("الرجاء التأكد من اختيار زبون");return}F.mutate({customerId:i.length>0?i[0].id:"نقدي",totalPrice:h,products:C,paymentStatus:n==="cash"?"cash":n==="part"?"part":"debt",remainingDebt:n==="cash"?0:n==="part"?h-(c=="USD"?Number(a):Number((Number(a)/y).toFixed(1))):h,currency:c,exchangeRate:y,amount_base:h*y,partValue:Number(a)})},children:"اتمام عملية البيع"})]})]})]})})}export{he as default};
