import{b as X,a5 as Z,r as n,u as ee,a as k,c as te,j as e,D as se,B as i,A as ae,C as O,a4 as re}from"./index-DedAuGlY.js";import{D as q}from"./DataTable-wi21OHCC.js";import{C as ne,S as le,P as oe}from"./Skeleton-q-APj7gj.js";import{P as C,F as u}from"./FormInput-YgIorFMR.js";import{S as T,a as F,b as U,c as V,d as A}from"./select-Cfpajtue.js";import{b as ie}from"./customer-gawJjULT.js";import{a as ue,h as ce}from"./transaction-BHRmm8md.js";import{C as E}from"./CardContent-BzpEjvtS.js";import"./input-CJ8UGXAQ.js";import"./DefaultPropsProvider-CHnXbyy1.js";import"./useSlot-BfW2NbCx.js";function De(){const N=X(),m=Z().state,[L,b]=n.useState(!1),[B,g]=n.useState(!1),[o,j]=n.useState(0),[x,y]=n.useState(""),D=ee(),[Q,f]=n.useState(!1),[c,w]=n.useState({}),[h,K]=n.useState("cash"),[I,M]=n.useState(0),[P,z]=n.useState(""),[l,S]=n.useState(""),[d,v]=n.useState(1),[me,pe]=n.useState(!1),R=k({mutationFn:t=>ue(t),onSuccess:()=>{alert("تم إضافة الدفعة بنجاح!"),j(0),y(""),S(""),v(1),g(!1),b(!1),D.invalidateQueries({queryKey:["customer-details"]})},onError:t=>{console.error(t),alert("حدث خطأ أثناء إضافة المنتج")}}),Y=k({mutationFn:t=>ce(t),onSuccess:()=>{D.invalidateQueries({queryKey:["customer-details"]})},onError:t=>{console.error(t),alert("حدث خطأ أثناء الإرجاع")}}),[_,G]=n.useState({}),{data:r,isLoading:H}=te({queryKey:["customer-details",m],queryFn:()=>ie(m),enabled:!!m});r&&_.id!==r.id&&G(r);const $=[{label:"المعرف",key:"id",hidden:!0},{label:"المبلغ",key:"amount"},{label:"الوصف",key:"note"},{label:"التاريخ",key:"date"}],J=[{label:"المعرف",key:"id",hidden:!0},{label:"السعر النهائي",key:"totalPrice"},{label:"المنتجات",key:"productsString"},{label:"التاريخ",key:"date"}];return e.jsx(se,{children:e.jsxs("div",{className:"space-y-6",dir:"rtl",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h1",{className:"text-3xl font-bold",children:"بيانات الزبون"}),e.jsxs(i,{onClick:()=>N("/customers"),variant:"outline",children:[e.jsx(ae,{className:"ml-2 w-4 h-4"})," رجوع"]})]}),e.jsxs(O,{children:[e.jsx(ne,{children:e.jsx(re,{children:"المعلومات الأساسية"})}),e.jsxs(E,{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[r&&Object.entries(r.data).map(([t,s])=>["payments","purchases","id"].includes(t)?null:e.jsxs("p",{className:"flex gap-2 relative group mb-4 items-end",children:[e.jsxs("label",{className:"block font-bold w-36",children:[t,":"]}),t.includes("date")&&new Date(s).toString()!=="Invalid Date"?e.jsx("input",{type:"text",value:new Date(s).toLocaleString("en-GB"),readOnly:!0,className:"bg-transparent border-b-2 border-transparent focus:border-primary-500 outline-none transition-all w-full"}):e.jsx("input",{type:"text",value:s,readOnly:!0,className:"bg-transparent border-b-2 border-transparent focus:border-primary-500 outline-none transition-all w-full"}),e.jsx("span",{className:"absolute bottom-0 right-0 w-full h-[2px] bg-primary-500 scale-x-0 group-hover:scale-x-100 origin-right transition-transform duration-300"})]},t)),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(C,{title:"اضافة دفعة",trigger:e.jsx(i,{onClick:t=>{g(!0),t.stopPropagation()},variant:"accent",size:"sm",className:"w-full",children:"اضافة دفعة من الزبون"}),isOpen:B,setIsOpen:g,children:e.jsxs("form",{className:"space-y-4 mt-4",onSubmit:t=>{t.preventDefault(),R.mutate({customerId:m.id,amount:l=="USD"?o:Number((o/d).toFixed(1)),note:x,currency:l,exchangeRate:d,amount_base:o})},children:[e.jsx(u,{label:"قيمة الدفعة",id:"payment-amount",type:"number",value:o.toString(),onChange:t=>j(Number(t.target.value))}),e.jsx(u,{label:"ملاحظات",id:"note",type:"text",value:x,onChange:t=>y(t.target.value)}),h!="debt"&&e.jsxs(e.Fragment,{children:[" ",e.jsxs(T,{value:l,onValueChange:S,children:[e.jsx(F,{className:"w-full mt-6",children:e.jsx(U,{placeholder:"العملة المدفوع بها"})}),e.jsx(V,{children:["SYP","USD"].map(t=>e.jsx(A,{value:t,children:t},t))})]}),e.jsx(u,{id:"exchangeRate",label:"سعر الصرف",value:l=="USD"?1:d,onChange:t=>v(Number(t.target.value)),disabled:l==="USD"})]}),e.jsx(i,{className:"w-full",type:"submit",children:"اضافة دفعة"})]})}),e.jsx(C,{title:"دفع للزبون",trigger:e.jsx(i,{onClick:t=>{b(!0),t.stopPropagation()},variant:"destructive",size:"sm",className:"w-full",children:"دفع للزبون"}),isOpen:L,setIsOpen:b,children:e.jsxs("form",{className:"space-y-4 mt-4",onSubmit:t=>{t.preventDefault(),R.mutate({customerId:m.id,amount:l=="USD"?-o:-Number((o/d).toFixed(1)),note:x,currency:l,exchangeRate:d,amount_base:-o})},children:[e.jsx(u,{label:"قيمة الدفعة",id:"payment-amount",type:"number",value:o.toString(),onChange:t=>j(Number(t.target.value))}),e.jsx(u,{label:"ملاحظات",id:"note",type:"text",value:x,onChange:t=>y(t.target.value)}),h!="debt"&&e.jsxs(e.Fragment,{children:[" ",e.jsxs(T,{value:l,onValueChange:S,children:[e.jsx(F,{className:"w-full mt-6",children:e.jsx(U,{placeholder:"العملة المدفوع بها"})}),e.jsx(V,{children:["SYP","USD"].map(t=>e.jsx(A,{value:t,children:t},t))})]}),e.jsx(u,{id:"exchangeRate",label:"سعر الصرف",value:l=="USD"?1:d,onChange:t=>v(Number(t.target.value)),disabled:l==="USD"})]}),e.jsx(i,{className:"w-full",type:"submit",children:"اضافة دفعة"})]})})]})]})]}),e.jsx(O,{className:"overflow-x-auto",children:H?e.jsx(le,{className:"h-48 w-full"}):r!=null&&r.data?e.jsxs(E,{className:"space-y-4 md:space-y-0 grid md:grid-cols-2 gap-4",children:[e.jsx(q,{title:"الدفعات",columns:$,data:r==null?void 0:r.data.payments}),e.jsx(q,{title:"عمليات الشراء",columns:J,data:r?r.data.purchases.map(t=>({...t,productsString:t.products.map(s=>s.name).join(", ")})):[],renderRowActions:t=>e.jsxs("div",{className:"flex gap-2",children:[e.jsx(i,{variant:"outline",onClick:()=>{N("/sellDetails",{state:t.id})},children:"تفاصيل"}),e.jsx(C,{title:"إرجاع منتجات الفاتورة",isOpen:Q,setIsOpen:f,trigger:e.jsx(i,{onClick:()=>f(!0),children:"إرجاع"}),children:e.jsxs("form",{className:"space-y-4",onSubmit:s=>{s.preventDefault(),t.products.filter(a=>(c[a.id]||0)>0).map(a=>({productId:a.id,productCode:a.code,customerId:t.customerId,warehouse:a.warehouse,qty:-c[a.id],returnValue:c[a.id]*a.sellPrice,referenceId:t.id,partValue:I,returnType:h,reason:P})).forEach(a=>Y.mutate(a)),alert("تم تسجيل الإرجاع بنجاح!"),f(!1),w({})},children:[t.products.map(s=>e.jsxs("div",{className:"border p-2 rounded-md",children:[e.jsx("p",{className:"font-semibold",children:s.name}),e.jsxs("p",{children:["الكمية الأصلية: ",s.qty]}),e.jsxs("p",{children:["سعر الوحدة: ",s.sellPrice]}),e.jsx(u,{id:`return-${s.id}`,label:"كمية الإرجاع",type:"number",min:0,max:s.qty,value:(c[s.id]||0).toString(),onChange:p=>{let a=Number(p.target.value);a>s.qty&&(a=s.qty),a<0&&(a=0),w(W=>({...W,[s.id]:a}))}}),e.jsxs("p",{children:["المبلغ:"," ",(c[s.id]||0)*s.sellPrice]})]},s.id)),e.jsxs("p",{className:"font-bold",children:["المجموع الكلي:"," ",t.products.reduce((s,p)=>s+(c[p.id]||0)*p.sellPrice,0)]}),e.jsx(oe,{value:h,onChange:K,partValue:I,onPartValueChange:s=>M(s)}),e.jsx(u,{id:"return-reason",label:"ملاحظات",type:"text",value:P,onChange:s=>{z(s.target.value)}}),e.jsx(i,{type:"submit",className:"w-full",children:"تأكيد الإرجاع"})]})})]}),onRowClick:t=>{console.log(t)}})]}):e.jsx("p",{className:"text-muted-foreground text-center",children:"لا توجد معاملات حالياً."})})]})})}export{De as default};
