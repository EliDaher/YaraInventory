import{G as A,j as e,f as k,R as E,r as q,J as g,l as K}from"./index-Os8Og7uJ.js";import{F as l,P as R,S as F,a as I,b as U,c as w,d as v}from"./FormInput-CGgAf-ka.js";import{B as j}from"./button-BUEtkSAn.js";import{u as T}from"./useMutation-RhoykwT-.js";import{d as J,f as M}from"./transaction-BBceugoW.js";import{z as s,u as Q,C as b,t as Y}from"./index-BCF7n9AF.js";import{S as _}from"./SupplierSelect-CBmm_Ekc.js";import{D as z}from"./DataTable-DlfUubZH.js";import{P as G}from"./PaymentTypeSelector-Q9xVMSmT.js";const L=s.object({name:s.string().min(1,"اسم المنتج مطلوب"),code:s.string().min(1,"رمز المنتج مطلوب"),category:s.string().min(1,"الصنف مطلوب"),warehouse:s.string().min(1,"المستودع مطلوب"),payPrice:s.coerce.number().positive(),sellPrice:s.coerce.number().positive(),quantity:s.coerce.number().positive(),unit:s.string().min(1),supplierId:s.string().min(1,"المورد مطلوب"),isDebt:s.enum(["cash","part","debt"]),partValue:s.coerce.number().optional(),currency:s.enum(["USD","SYP"]).optional(),exchangeRate:s.coerce.number().default(1)});function B({value:i,onChange:d,label:n}){const{data:m=[],isLoading:p}=A(),y=i==="other";return e.jsxs("div",{children:[!y&&e.jsx(l,{disabled:p,label:n||"المستودع المنقول إليه",value:i,options:m.map(a=>{var x;return(x=a.name)==null?void 0:x.trim()}).filter(Boolean).map(a=>({id:a,name:a})),onChange:a=>d(a.target.value)}),y&&e.jsx(l,{label:"المستودع المنقول إليه",placeholder:"أدخل اسم المستودع الجديد",onBlur:a=>{a.target.value&&d(a.target.value)}})]})}function se({isOpen:i,setIsOpen:d,row:n}){var c,V;const m=k(),[p,y]=E.useState(!1),{register:a,handleSubmit:x,watch:o,reset:u,control:S,setValue:D,formState:{errors:h}}=Q({resolver:Y(L),defaultValues:{isDebt:"cash",currency:"USD",exchangeRate:1}}),P=o("isDebt"),N=o("currency");q.useEffect(()=>{n&&u({name:n.name,code:n.code,category:n.category,warehouse:n.warehouse,payPrice:n.payPrice,sellPrice:n.sellPrice,unit:n.unit,quantity:n.quantity??1,supplierId:n.supplierId??"",isDebt:"cash",currency:"USD",exchangeRate:1})},[n,u]);const f=T({mutationFn:t=>J(t),onSuccess:()=>{u(),d(!1),m.invalidateQueries({queryKey:["products-table"]})}}),r=t=>{const C=t.quantity*t.payPrice;if(t.isDebt!=="debt"&&!t.currency){g.error("الرجاء اختيار العملة");return}if(t.isDebt==="part"&&(t.partValue??0)<=0){g.error("الرجاء إدخال قيمة الدفعة الجزئية");return}if(t.isDebt!=="debt"&&t.currency==="SYP"&&t.exchangeRate<=0){g.error("الرجاء إدخال سعر صرف صحيح");return}if(t.isDebt==="part"&&(t.partValue??0)>=C){g.error("قيمة الدفعة الجزئية لا يمكن أن تكون أكبر أو تساوي المبلغ الكلي");return}const W=t.isDebt==="debt"?C:t.isDebt==="cash"?0:C-(t.currency==="USD"?t.partValue:Number((t.partValue/t.exchangeRate).toFixed(1)));f.mutate({newProduct:{name:t.name,code:t.code,category:t.category,warehouse:t.warehouse,payPrice:t.payPrice,sellPrice:t.sellPrice,unit:t.unit,quantity:t.quantity},newPurchase:{supplierId:t.supplierId,name:t.name,code:t.code,warehouse:t.warehouse,quantity:t.quantity,payPrice:t.payPrice,currency:t.currency,exchangeRate:t.exchangeRate,amount_base:t.payPrice*t.exchangeRate,totalPrice:C,paymentStatus:"pending",remainingDebt:W}}),m.invalidateQueries({queryKey:["products-table"]})};return e.jsx(R,{trigger:e.jsx(e.Fragment,{}),title:n?"تعديل المنتج":"شراء منتجات",isOpen:i,setIsOpen:d,children:e.jsxs("form",{dir:"rtl",onSubmit:x(r),className:"grid grid-cols-1 md:grid-cols-2 gap-4 max-h-[75vh] overflow-y-auto overflow-x-hidden",children:[e.jsx(l,{label:"اسم المنتج",...a("name"),error:(c=h.name)==null?void 0:c.message}),e.jsx(l,{label:"رمز المنتج",...a("code"),error:(V=h.code)==null?void 0:V.message}),e.jsx(l,{label:"الصنف",...a("category")}),e.jsx(b,{control:S,name:"warehouse",render:({field:t})=>e.jsx(B,{label:"المستودع",value:t.value,onChange:t.onChange})}),e.jsx(l,{label:"سعر الشراء",type:"number",...a("payPrice")}),e.jsx(l,{label:"سعر المبيع",type:"number",...a("sellPrice")}),e.jsx(l,{label:"الكمية",type:"number",...a("quantity")}),e.jsx(l,{label:"الواحدة",...a("unit")}),e.jsx("div",{className:"md:col-span-2 grid grid-cols-3 gap-2",children:["cash","part","debt"].map(t=>e.jsx(j,{type:"button",variant:P===t?"default":"outline",onClick:()=>D("isDebt",t),children:t==="cash"?"نقداً":t==="part"?"جزئي":"دين"},t))}),P==="part"&&e.jsx(l,{label:"قيمة الدفعة",type:"number",...a("partValue")}),P!=="debt"&&e.jsxs(e.Fragment,{children:[e.jsx(b,{control:S,name:"currency",render:({field:t})=>e.jsxs(F,{value:t.value,onValueChange:t.onChange,children:[e.jsx(I,{className:"mt-6",children:e.jsx(U,{placeholder:"العملة"})}),e.jsxs(w,{children:[e.jsx(v,{value:"USD",children:"USD"}),e.jsx(v,{value:"SYP",children:"SYP"})]})]})}),e.jsx(l,{label:"سعر الصرف",type:"number",disabled:N==="USD",...a("exchangeRate")})]}),e.jsx(b,{control:S,name:"supplierId",render:({field:t})=>e.jsx(_,{className:"mt-6",isOpen:p,setIsOpen:y,supplierId:t.value,setSupplierId:t.onChange,withDataTable:!0})}),e.jsx(j,{className:"md:col-span-2",type:"submit",disabled:f.isPending,children:f.isPending?"جارٍ الحفظ...":n?"تعديل":"إضافة"})]})})}const ie=({productsData:i,setEditRow:d,setOpenForm:n,setOpenTransfare:m,setProductRow:p,isLoading:y})=>{const a=K(),x=[{key:"id",label:"المعرف",sortable:!0,hidden:!0},{key:"code",label:"الرمز",sortable:!0},{key:"name",label:"الاسم",sortable:!0},{key:"quantity",label:"الكمية",sortable:!0},{key:"warehouse",label:"المخزن",sortable:!0},{key:"payPrice",label:"سعر الشراء",sortable:!0,onlyAdmin:!0},{key:"sellPrice",label:"سعر المبيع",sortable:!0},{key:"category",label:"الصنف",sortable:!0},{key:"unit",label:"الواحدة",sortable:!0}];return e.jsx(e.Fragment,{children:e.jsx(z,{isLoading:y,title:"قائمة المنتجات",titleButton:e.jsx(j,{onClick:()=>{d(null),n(!0)},className:"",children:"إضافة منتج"}),columns:x,data:i,getRowClassName:o=>o.quantity===0?"bg-destructive/20 hover:bg-destructive/40":o.quantity<5?"bg-yellow-500/20 hover:bg-yellow-500/40":"",renderRowActions:o=>e.jsxs("div",{className:"flex gap-1",children:[e.jsx(j,{variant:"default",onClick:u=>{u.stopPropagation(),d(o),n(!0)},children:"شراء"}),e.jsx(j,{variant:"outline",onClick:u=>{u.stopPropagation(),a("/productDetails",{state:o})},children:"التفاصيل"}),e.jsx(j,{variant:"secondary",onClick:u=>{u.stopPropagation(),p(o),m(!0)},children:"نقل"})]})})})},O=s.object({warehouse:s.string().min(1,"اختر المستودع المنقول إليه"),quantity:s.coerce.number().positive("الكمية يجب أن تكون أكبر من صفر"),sellPrice:s.coerce.number().positive("سعر المبيع غير صحيح"),amount:s.coerce.number().min(0,"تكلفة النقل غير صحيحة"),currency:s.enum(["USD","SYP"]),note:s.string().optional()});function le({row:i,isOpen:d,setIsOpen:n}){const m=k(),[p,y]=q.useState("cash"),[a,x]=q.useState(0),{control:o,handleSubmit:u,reset:S,setValue:D,formState:{errors:h}}=Q({resolver:Y(O),defaultValues:{warehouse:"",quantity:0,sellPrice:i.sellPrice,amount:0,currency:"USD",note:""}});q.useEffect(()=>{i&&S({warehouse:"",quantity:0,sellPrice:i.sellPrice,amount:0,currency:"USD",note:""})},[i,S]);const P=T({mutationFn:r=>M(r),onSuccess:()=>{n(!1),m.invalidateQueries({queryKey:["products-table"]}),m.invalidateQueries({queryKey:["warehouses-table"]})},onError:r=>{console.error(r),g.error("حدث خطأ أثناء نقل المنتج")}}),N=r=>{if(r.quantity>i.quantity){g.error("الكمية المدخلة أكبر من الكمية المتوفرة");return}if(p==="part"&&a<=0){g.error("الرجاء إدخال قيمة الدفعة الجزئية");return}if(p==="part"&&a>=r.amount){g.error("قيمة الدفعة الجزئية يجب أن تكون أقل من المبلغ الكلي");return}P.mutate({productId:i.id,oldWarehouse:i.warehouse,newWarehouse:r.warehouse,exchangeRate:0,amount_base:r.amount,amount:r.amount,currency:r.currency,quantity:r.quantity,note:r.note,newSellPrice:r.sellPrice})},f=()=>{D("quantity",i.quantity)};return e.jsx(R,{isOpen:d,setIsOpen:n,trigger:e.jsx(e.Fragment,{}),title:"نقل منتج",children:e.jsx("form",{onSubmit:u(N),children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 max-h-[75vh] overflow-y-auto overflow-x-hidden",children:[e.jsx(l,{label:"اسم المنتج",disabled:!0,value:i.name}),e.jsx(l,{label:"صنف المنتج",disabled:!0,value:i.category}),e.jsx(l,{label:"الواحدة",disabled:!0,value:i.unit}),e.jsx(l,{label:"المستودع القديم",disabled:!0,value:i.warehouse}),e.jsx(b,{name:"warehouse",control:o,render:({field:r})=>e.jsx(B,{value:r.value,onChange:r.onChange})}),h.warehouse&&e.jsx("p",{className:"text-red-500 text-sm",children:h.warehouse.message}),e.jsxs("div",{className:"flex",children:[e.jsx(b,{name:"quantity",control:o,render:({field:r})=>e.jsx(l,{type:"number",label:"الكمية المراد نقلها",value:r.value,onChange:c=>r.onChange(Number(c.target.value)),className:"rounded-l-none"})}),e.jsx(j,{type:"button",className:"mt-6 rounded-r-none",onClick:f,children:i.quantity})]}),h.quantity&&e.jsx("p",{className:"text-red-500 text-sm",children:h.quantity.message}),e.jsx(b,{name:"sellPrice",control:o,render:({field:r})=>e.jsx(l,{type:"number",label:"سعر المبيع",value:r.value,onChange:c=>r.onChange(Number(c.target.value))})}),h.sellPrice&&e.jsx("p",{className:"text-red-500 text-sm",children:h.sellPrice.message}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-2 md:col-span-1",children:[e.jsx("div",{className:"sm:col-span-2",children:e.jsx(b,{name:"amount",control:o,render:({field:r})=>e.jsx(l,{label:"تكلفة النقل",value:r.value,onChange:c=>r.onChange(Number(c.target.value)),className:"rounded-l-none"})})}),e.jsx(b,{name:"currency",control:o,render:({field:r})=>e.jsxs(F,{value:r.value,onValueChange:r.onChange,children:[e.jsx(I,{className:"mt-6 rounded-r-none",children:e.jsx(U,{placeholder:"العملة"})}),e.jsx(w,{children:["SYP","USD"].map(c=>e.jsx(v,{value:c,children:c},c))})]})})]}),e.jsx("div",{className:"md:col-span-2",children:e.jsx(G,{value:p,onChange:y,partValue:a,onPartValueChange:x})}),e.jsx("div",{className:"md:col-span-2",children:e.jsx(b,{name:"note",control:o,render:({field:r})=>e.jsx(l,{label:"ملاحظات النقل",value:r.value,onChange:r.onChange})})}),e.jsx(j,{type:"submit",className:"w-full md:col-span-2",disabled:P.isPending,children:P.isPending?"جاري النقل...":"تأكيد"})]})})})}export{se as A,ie as P,le as T};
