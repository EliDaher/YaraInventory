import{K,j as e,h as V,R as W,r as C,m as A}from"./index-DiQH1MVD.js";import{F as i,P as k,S as R,a as F,b as I,c as U,d as N}from"./FormInput-CASvz7qr.js";import{B as g}from"./button-OYVM9TCz.js";import{u as w}from"./useMutation-B7Bn7gVY.js";import{c as E,d as M}from"./transaction-Ccp5uWBE.js";import{z as s,u as T,C as b,t as Q}from"./index-sROSo7XJ.js";import{S as _}from"./SupplierSelect-B_pDNaXv.js";import{D as z}from"./DataTable-wCIb_9w-.js";import{P as L}from"./PaymentTypeSelector-DxuXxXDr.js";const O=s.object({name:s.string().min(1,"اسم المنتج مطلوب"),code:s.string().min(1,"رمز المنتج مطلوب"),category:s.string().min(1,"الصنف مطلوب"),warehouse:s.string().min(1,"المستودع مطلوب"),payPrice:s.coerce.number().positive(),sellPrice:s.coerce.number().positive(),quantity:s.coerce.number().positive(),unit:s.string().min(1),supplierId:s.string().min(1,"المورد مطلوب"),isDebt:s.enum(["cash","part","debt"]),partValue:s.coerce.number().optional(),currency:s.enum(["USD","SYP"]).optional(),exchangeRate:s.coerce.number().default(1)});function Y({value:l,onChange:d,label:n}){const{data:m=[],isLoading:h}=K(),y=l==="other";return e.jsxs("div",{children:[!y&&e.jsx(i,{disabled:h,label:n||"المستودع المنقول إليه",value:l,options:m.map(r=>{var x;return(x=r.name)==null?void 0:x.trim()}).filter(Boolean).map(r=>({id:r,name:r})),onChange:r=>d(r.target.value)}),y&&e.jsx(i,{label:"المستودع المنقول إليه",placeholder:"أدخل اسم المستودع الجديد",onBlur:r=>{r.target.value&&d(r.target.value)}})]})}function ne({isOpen:l,setIsOpen:d,row:n}){var o,v;const m=V(),[h,y]=W.useState(!1),{register:r,handleSubmit:x,watch:c,reset:u,control:P,setValue:q,formState:{errors:p}}=T({resolver:Q(O),defaultValues:{isDebt:"cash",currency:"USD",exchangeRate:1}}),j=c("isDebt"),D=c("currency");C.useEffect(()=>{n&&u({name:n.name,code:n.code,category:n.category,warehouse:n.warehouse,payPrice:n.payPrice,sellPrice:n.sellPrice,unit:n.unit,quantity:n.quantity??1,supplierId:n.supplierId??"",isDebt:"cash",currency:"USD",exchangeRate:1})},[n,u]);const S=w({mutationFn:t=>E(t),onSuccess:()=>{u(),d(!1),m.invalidateQueries({queryKey:["products-table"]})}}),a=t=>{const f=t.quantity*t.payPrice;if(t.isDebt!=="debt"&&!t.currency){alert("الرجاء اختيار العملة");return}if(t.isDebt==="part"&&(t.partValue??0)<=0){alert("الرجاء إدخال قيمة الدفعة الجزئية");return}if(t.isDebt!=="debt"&&t.currency==="SYP"&&t.exchangeRate<=0){alert("الرجاء إدخال سعر صرف صحيح");return}if(t.isDebt==="part"&&(t.partValue??0)>=f){alert("قيمة الدفعة الجزئية لا يمكن أن تكون أكبر أو تساوي المبلغ الكلي");return}const B=t.isDebt==="debt"?f:t.isDebt==="cash"?0:f-(t.currency==="USD"?t.partValue:Number((t.partValue/t.exchangeRate).toFixed(1)));S.mutate({newProduct:{name:t.name,code:t.code,category:t.category,warehouse:t.warehouse,payPrice:t.payPrice,sellPrice:t.sellPrice,unit:t.unit,quantity:t.quantity},newPurchase:{supplierId:t.supplierId,name:t.name,code:t.code,warehouse:t.warehouse,quantity:t.quantity,payPrice:t.payPrice,currency:t.currency,exchangeRate:t.exchangeRate,amount_base:t.payPrice*t.exchangeRate,totalPrice:f,paymentStatus:"pending",remainingDebt:B}}),m.invalidateQueries({queryKey:["products-table"]})};return e.jsx(k,{trigger:e.jsx(e.Fragment,{}),title:n?"تعديل المنتج":"شراء منتجات",isOpen:l,setIsOpen:d,children:e.jsxs("form",{dir:"rtl",onSubmit:x(a),className:"grid grid-cols-1 md:grid-cols-2 gap-4 max-h-[75vh] overflow-y-auto overflow-x-hidden",children:[e.jsx(i,{label:"اسم المنتج",...r("name"),error:(o=p.name)==null?void 0:o.message}),e.jsx(i,{label:"رمز المنتج",...r("code"),error:(v=p.code)==null?void 0:v.message}),e.jsx(i,{label:"الصنف",...r("category")}),e.jsx(b,{control:P,name:"warehouse",render:({field:t})=>e.jsx(Y,{label:"المستودع",value:t.value,onChange:t.onChange})}),e.jsx(i,{label:"سعر الشراء",type:"number",...r("payPrice")}),e.jsx(i,{label:"سعر المبيع",type:"number",...r("sellPrice")}),e.jsx(i,{label:"الكمية",type:"number",...r("quantity")}),e.jsx(i,{label:"الواحدة",...r("unit")}),e.jsx("div",{className:"md:col-span-2 grid grid-cols-3 gap-2",children:["cash","part","debt"].map(t=>e.jsx(g,{type:"button",variant:j===t?"default":"outline",onClick:()=>q("isDebt",t),children:t==="cash"?"نقداً":t==="part"?"جزئي":"دين"},t))}),j==="part"&&e.jsx(i,{label:"قيمة الدفعة",type:"number",...r("partValue")}),j!=="debt"&&e.jsxs(e.Fragment,{children:[e.jsx(b,{control:P,name:"currency",render:({field:t})=>e.jsxs(R,{value:t.value,onValueChange:t.onChange,children:[e.jsx(F,{className:"mt-6",children:e.jsx(I,{placeholder:"العملة"})}),e.jsxs(U,{children:[e.jsx(N,{value:"USD",children:"USD"}),e.jsx(N,{value:"SYP",children:"SYP"})]})]})}),e.jsx(i,{label:"سعر الصرف",type:"number",disabled:D==="USD",...r("exchangeRate")})]}),e.jsx(b,{control:P,name:"supplierId",render:({field:t})=>e.jsx(_,{className:"mt-6",isOpen:h,setIsOpen:y,supplierId:t.value,setSupplierId:t.onChange,withDataTable:!0})}),e.jsx(g,{className:"md:col-span-2",type:"submit",disabled:S.isPending,children:S.isPending?"جارٍ الحفظ...":n?"تعديل":"إضافة"})]})})}const se=({productsData:l,setEditRow:d,setOpenForm:n,setOpenTransfare:m,setProductRow:h,isLoading:y})=>{const r=A(),x=[{key:"id",label:"المعرف",sortable:!0,hidden:!0},{key:"code",label:"الرمز",sortable:!0},{key:"name",label:"الاسم",sortable:!0},{key:"quantity",label:"الكمية",sortable:!0},{key:"warehouse",label:"المخزن",sortable:!0},{key:"payPrice",label:"سعر الشراء",sortable:!0,onlyAdmin:!0},{key:"sellPrice",label:"سعر المبيع",sortable:!0},{key:"category",label:"الصنف",sortable:!0},{key:"unit",label:"الواحدة",sortable:!0}];return e.jsx(e.Fragment,{children:e.jsx(z,{isLoading:y,title:"قائمة المنتجات",titleButton:e.jsx(g,{onClick:()=>{d(null),n(!0)},className:"",children:"إضافة منتج"}),columns:x,data:l,getRowClassName:c=>c.quantity===0?"bg-destructive/20 hover:bg-destructive/40":c.quantity<5?"bg-yellow-500/20 hover:bg-yellow-500/40":"",renderRowActions:c=>e.jsxs("div",{className:"flex gap-1",children:[e.jsx(g,{variant:"default",onClick:u=>{u.stopPropagation(),d(c),n(!0)},children:"شراء"}),e.jsx(g,{variant:"outline",onClick:u=>{u.stopPropagation(),r("/productDetails",{state:c})},children:"التفاصيل"}),e.jsx(g,{variant:"secondary",onClick:u=>{u.stopPropagation(),h(c),m(!0)},children:"نقل"})]})})})},G=s.object({warehouse:s.string().min(1,"اختر المستودع المنقول إليه"),quantity:s.coerce.number().positive("الكمية يجب أن تكون أكبر من صفر"),sellPrice:s.coerce.number().positive("سعر المبيع غير صحيح"),amount:s.coerce.number().min(0,"تكلفة النقل غير صحيحة"),currency:s.enum(["USD","SYP"]),note:s.string().optional()});function le({row:l,isOpen:d,setIsOpen:n}){const m=V(),[h,y]=C.useState("cash"),[r,x]=C.useState(0),{control:c,handleSubmit:u,reset:P,setValue:q,formState:{errors:p}}=T({resolver:Q(G),defaultValues:{warehouse:"",quantity:0,sellPrice:l.sellPrice,amount:0,currency:"USD",note:""}});C.useEffect(()=>{l&&P({warehouse:"",quantity:0,sellPrice:l.sellPrice,amount:0,currency:"USD",note:""})},[l,P]);const j=w({mutationFn:a=>M(a),onSuccess:()=>{n(!1),m.invalidateQueries({queryKey:["products-table"]}),m.invalidateQueries({queryKey:["warehouses-table"]})},onError:a=>{console.error(a),alert("حدث خطأ أثناء نقل المنتج")}}),D=a=>{if(a.quantity>l.quantity){alert("الكمية المدخلة أكبر من الكمية المتوفرة");return}if(h==="part"&&r<=0){alert("الرجاء إدخال قيمة الدفعة الجزئية");return}if(h==="part"&&r>=a.amount){alert("قيمة الدفعة الجزئية يجب أن تكون أقل من المبلغ الكلي");return}j.mutate({productId:l.id,oldWarehouse:l.warehouse,newWarehouse:a.warehouse,exchangeRate:0,amount_base:a.amount,amount:a.amount,currency:a.currency,quantity:a.quantity,note:a.note,newSellPrice:a.sellPrice})},S=()=>{q("quantity",l.quantity)};return e.jsx(k,{isOpen:d,setIsOpen:n,trigger:e.jsx(e.Fragment,{}),title:"نقل منتج",children:e.jsx("form",{onSubmit:u(D),children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 max-h-[75vh] overflow-y-auto overflow-x-hidden",children:[e.jsx(i,{label:"اسم المنتج",disabled:!0,value:l.name}),e.jsx(i,{label:"صنف المنتج",disabled:!0,value:l.category}),e.jsx(i,{label:"الواحدة",disabled:!0,value:l.unit}),e.jsx(i,{label:"المستودع القديم",disabled:!0,value:l.warehouse}),e.jsx(b,{name:"warehouse",control:c,render:({field:a})=>e.jsx(Y,{value:a.value,onChange:a.onChange})}),p.warehouse&&e.jsx("p",{className:"text-red-500 text-sm",children:p.warehouse.message}),e.jsxs("div",{className:"flex",children:[e.jsx(b,{name:"quantity",control:c,render:({field:a})=>e.jsx(i,{type:"number",label:"الكمية المراد نقلها",value:a.value,onChange:o=>a.onChange(Number(o.target.value)),className:"rounded-l-none"})}),e.jsx(g,{type:"button",className:"mt-6 rounded-r-none",onClick:S,children:l.quantity})]}),p.quantity&&e.jsx("p",{className:"text-red-500 text-sm",children:p.quantity.message}),e.jsx(b,{name:"sellPrice",control:c,render:({field:a})=>e.jsx(i,{type:"number",label:"سعر المبيع",value:a.value,onChange:o=>a.onChange(Number(o.target.value))})}),p.sellPrice&&e.jsx("p",{className:"text-red-500 text-sm",children:p.sellPrice.message}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-2 md:col-span-1",children:[e.jsx("div",{className:"sm:col-span-2",children:e.jsx(b,{name:"amount",control:c,render:({field:a})=>e.jsx(i,{label:"تكلفة النقل",value:a.value,onChange:o=>a.onChange(Number(o.target.value)),className:"rounded-l-none"})})}),e.jsx(b,{name:"currency",control:c,render:({field:a})=>e.jsxs(R,{value:a.value,onValueChange:a.onChange,children:[e.jsx(F,{className:"mt-6 rounded-r-none",children:e.jsx(I,{placeholder:"العملة"})}),e.jsx(U,{children:["SYP","USD"].map(o=>e.jsx(N,{value:o,children:o},o))})]})})]}),e.jsx("div",{className:"md:col-span-2",children:e.jsx(L,{value:h,onChange:y,partValue:r,onPartValueChange:x})}),e.jsx("div",{className:"md:col-span-2",children:e.jsx(b,{name:"note",control:c,render:({field:a})=>e.jsx(i,{label:"ملاحظات النقل",value:a.value,onChange:a.onChange})})}),e.jsx(g,{type:"submit",className:"w-full md:col-span-2",disabled:j.isPending,children:j.isPending?"جاري النقل...":"تأكيد"})]})})})}export{ne as A,se as P,le as T};
