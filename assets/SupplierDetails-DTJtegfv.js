import{c as te,a7 as ae,r as l,u as se,d as le,a as T,j as e,D as ne,B as o,A as re,C as V,a6 as ie}from"./index-BaSnlIDM.js";import{D as A}from"./DataTable-C6oFKokI.js";import{P as oe}from"./PaymentTypeSelector-CCjKzgds.js";import{P as j,F as i,e as E,a as L,b as B,c as Q,d as K}from"./FormInput-BlxF78eT.js";import{b as ue}from"./supplier-C5K5Dec7.js";import{c as ce,d as de}from"./transaction-ke_jorcF.js";import{C as me,S as pe}from"./Skeleton-CBp1iqUx.js";import{C as M}from"./CardContent-BxETiaAq.js";import"./input-_BL4U1zG.js";import"./DefaultPropsProvider-UNJqVgsU.js";import"./useSlot-SE3T33Pw.js";function we(){var O,k,q,F;const z=te(),u=ae().state,[Y,x]=l.useState(!1),[_,f]=l.useState(!1),[d,S]=l.useState(""),[r,h]=l.useState(""),[m,b]=l.useState(""),[v,$]=l.useState("cash"),[N,G]=l.useState(0),[C,H]=l.useState(""),[n,D]=l.useState(""),[c,P]=l.useState(1),[w,g]=l.useState(null),I=se(),[he,J]=l.useState({}),{data:s,isLoading:W}=le({queryKey:["supplier-details",u],queryFn:()=>ue(u),enabled:!!u});l.useEffect(()=>{s&&J(s)},[s]);const R=T({mutationFn:t=>ce(t),onSuccess:()=>{alert("تم إضافة الدفعة بنجاح!"),h(""),b(""),x(!1),f(!1),I.invalidateQueries({queryKey:["supplier-details"]})},onError:t=>{console.error(t),alert("حدث خطأ أثناء إضافة المنتج")}}),y=T({mutationFn:t=>de(t),onSuccess:()=>{alert("تم الارجاع بنجاح!"),S(""),g(null),I.invalidateQueries({queryKey:["supplier-details"]})},onError:t=>{console.error(t),alert("حدث خطأ أثناء ارجاع المنتج")}}),X=[{label:"المعرف",key:"id",hidden:!0},{label:"المبلغ",key:"amount"},{label:"الوصف",key:"note"},{label:"التاريخ",key:"date"}],Z=[{label:"المعرف",key:"id",hidden:!0},{label:"كود المادة",key:"code"},{label:"اسم المادة",key:"name"},{label:"الكمية",key:"quantity"},{label:"المستودع",key:"warehouse"},{label:"السعر النهائي",key:"totalPrice"},{label:"التاريخ",key:"date"}],ee=async(t,a)=>{var U;t.preventDefault();try{const p={productCode:a.code,supplierId:u.id,warehouse:a.warehouse,qty:-Number(d),returnType:v,returnValue:Number(d)*a.payPrice,referenceId:a.id,productId:a.id,partValue:N,reason:C};y.mutate(p)}catch(p){console.error("❌ خطأ أثناء الإرجاع:",((U=p.response)==null?void 0:U.data)||p.message)}};return e.jsx(ne,{children:e.jsxs("div",{className:"space-y-6",dir:"rtl",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h1",{className:"text-3xl font-bold",children:"بيانات المورد"}),e.jsxs(o,{onClick:()=>z(-1),variant:"outline",children:[e.jsx(re,{className:"ml-2 w-4 h-4"})," رجوع"]})]}),e.jsxs(V,{children:[e.jsx(me,{children:e.jsx(ie,{children:"المعلومات الأساسية"})}),e.jsxs(M,{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[s&&Object.entries(s.data).map(([t,a])=>t==="payments"||t==="purchases"||t==="id"?null:e.jsxs("p",{className:"flex gap-2 relative group mb-4 items-end",children:[e.jsxs("label",{className:"block font-bold w-36",children:[t,":"]}),t.includes("date")&&new Date(a).toString()!=="Invalid Date"?e.jsx("input",{type:"text",value:new Date(a).toLocaleString("en-GB"),readOnly:!0,className:"bg-transparent border-b-2 border-transparent focus:border-primary-500 outline-none transition-all w-full"}):e.jsx("input",{type:"text",value:a,readOnly:!0,className:"bg-transparent border-b-2 border-transparent focus:border-primary-500 outline-none transition-all w-full"}),e.jsx("span",{className:"absolute bottom-0 right-0 w-full h-[2px] bg-primary-500 scale-x-0 group-hover:scale-x-100 origin-right transition-transform duration-300"})]},t)),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(j,{title:"دفعة من المورد",trigger:e.jsx(o,{className:"w-full",onClick:t=>{x(!0),t.stopPropagation()},variant:"accent",size:"sm",children:"دفعة من المورد"}),isOpen:Y,setIsOpen:x,children:e.jsxs("form",{className:"space-y-4 mt-4",onSubmit:t=>{t.preventDefault(),R.mutate({supplierId:u,amount:n=="USD"?r:Number((Number(r)/c).toFixed(1)),note:m,currency:n,exchangeRate:c,amount_base:r})},children:[e.jsx(i,{label:"قيمة الدفعة",id:"payment-amount",type:"text",value:r,onChange:t=>h(t.target.value)}),e.jsx(i,{label:"ملاحظات",id:"note",type:"text",value:m,onChange:t=>b(t.target.value)}),e.jsxs(E,{value:n,onValueChange:D,children:[e.jsx(L,{className:"w-full mt-6",children:e.jsx(B,{placeholder:"العملة المدفوع بها"})}),e.jsx(Q,{children:["SYP","USD"].map(t=>e.jsx(K,{value:t,children:t},t))})]}),e.jsx(i,{id:"exchangeRate",label:"سعر الصرف",value:n=="USD"?1:c,onChange:t=>P(Number(t.target.value)),disabled:n==="USD"}),e.jsx(o,{className:"w-full",type:"submit",children:"دفع للمورد"})]})}),e.jsx(j,{title:"دفع للمورد",trigger:e.jsx(o,{className:"w-full",variant:"destructive",size:"sm",children:"دفع للمورد"}),isOpen:_,setIsOpen:f,children:e.jsxs("form",{className:"space-y-4 mt-4",onSubmit:t=>{t.preventDefault(),R.mutate({supplierId:u,amount:n=="USD"?-r:-Number((Number(r)/c).toFixed(1)),note:m,currency:n,exchangeRate:c,amount_base:-r})},children:[e.jsx(i,{label:"قيمة الدفعة",id:"payment-amount",type:"text",value:r,onChange:t=>h(t.target.value)}),e.jsx(i,{label:"ملاحظات",id:"note",type:"text",value:m,onChange:t=>b(t.target.value)}),e.jsxs(E,{value:n,onValueChange:D,children:[e.jsx(L,{className:"w-full mt-6",children:e.jsx(B,{placeholder:"العملة المدفوع بها"})}),e.jsx(Q,{children:["SYP","USD"].map(t=>e.jsx(K,{value:t,children:t},t))})]}),e.jsx(i,{id:"exchangeRate",label:"سعر الصرف",value:n=="USD"?1:c,onChange:t=>P(Number(t.target.value)),disabled:n==="USD"}),e.jsx(o,{className:"w-full",type:"submit",children:"دفع للمورد"})]})})]})]})]}),e.jsx(V,{className:"overflow-x-auto",children:W?e.jsx(pe,{className:"h-48 w-full"}):!((k=(O=s==null?void 0:s.data)==null?void 0:O.payments)!=null&&k.length)&&!((F=(q=s==null?void 0:s.data)==null?void 0:q.purchases)!=null&&F.length)?e.jsx("p",{className:"text-muted-foreground text-center",children:"لا توجد معاملات حالياً."}):e.jsxs(M,{className:"space-y-4 md:space-y-0 grid md:grid-cols-2 gap-4",children:[e.jsx(A,{title:"الدفعات",columns:X,data:s.data.payments,getRowClassName:t=>t.type!=="income"?"text-red-500":"text-green-500"}),e.jsx(A,{title:"عمليات الشراء",columns:Z,data:s.data.purchases,renderRowActions:t=>e.jsx(j,{title:`إرجاع منتج: ${t.code} - ${t.name||""}`,isOpen:w===t.id.toString(),setIsOpen:()=>g(null),trigger:e.jsx(o,{onClick:a=>{a.preventDefault(),a.stopPropagation(),g(t.id.toString()),console.log("row id:",w)},children:"إرجاع"}),children:e.jsxs("form",{onSubmit:a=>ee(a,t),className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(i,{label:"الكمية",id:"return-quantity",type:"number",value:d,onChange:a=>S(a.target.value)}),e.jsxs("p",{className:"text-sm text-gray-500",children:["الكمية الأصلية: ",t.quantity,e.jsx("br",{}),"سعر الواحدة: ",t.payPrice]})]}),e.jsxs("p",{className:"font-semibold",children:["المبلغ الإجمالي: ",t.payPrice*Number(d)]}),e.jsx(oe,{value:v,onChange:$,partValue:N,onPartValueChange:a=>G(a)}),e.jsx(i,{id:"return-reason",label:"ملاحظات",type:"text",value:C,onChange:a=>H(a.target.value)}),e.jsx("div",{className:"flex justify-end mt-2",children:e.jsx(o,{type:"submit",className:"w-full",disabled:y.isPending,children:y.isPending?"جاري التأكيد...":"تأكيد الإرجاع"})})]})})})]})})]})})}export{we as default};
