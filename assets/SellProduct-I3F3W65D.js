import{r as l,j as e,X as O,R as V,h as J,f as P,i as Q}from"./index-DiQH1MVD.js";import{C as U}from"./AddCustomerForm-D-yh0T73.js";import{D as B}from"./DataTable-wCIb_9w-.js";import{D as K}from"./badge-Bx_Zl_Rk.js";import{I as w}from"./input-Ynq1ZRzp.js";import{B as N}from"./button-OYVM9TCz.js";import{C as M,a as T,c as $}from"./card-DyAJYzyZ.js";import{F as v,S as z,a as H,b as X,c as Y,d as _}from"./FormInput-CASvz7qr.js";import{g as G}from"./customer-Dxl2PIIk.js";import{s as W}from"./transaction-Ccp5uWBE.js";import{u as Z}from"./useMutation-B7Bn7gVY.js";import"./table-BP0LvNdy.js";import"./search-C3BaVPNY.js";import"./house-C1rh5GAz.js";const ee=({products:b,onChange:x,setAmount:C})=>{const[u,g]=l.useState(""),[o,m]=l.useState([]),j=l.useMemo(()=>b.filter(t=>{var a,r;return((a=t==null?void 0:t.name)==null?void 0:a.toLowerCase().includes(u.toLowerCase()))||((r=t==null?void 0:t.code)==null?void 0:r.toLowerCase().includes(u.toLowerCase()))}),[b,u]),h=t=>{const a=o.find(r=>r.id===t.id);if(a)p(t.id,a.qty+1);else{const r=[...o,{...t,qty:1}];m(r),x(r)}},p=(t,a)=>{var d;if(a>((d=b.find(c=>c.id===t))==null?void 0:d.quantity)){alert("الكمية المطلوبة غير متوفرة في المخزون");return}const r=o.map(c=>c.id===t?{...c,qty:a}:c).filter(c=>c.qty>=0);m(r),x(r)},i=(t,a)=>{const r=o.map(d=>d.id===t?{...d,sellPrice:a}:d).filter(d=>d.qty>=0);m(r),x(r)},S=t=>{const a=o.filter(r=>r.id!==t);m(a),x(a)},n=o.reduce((t,a)=>t+a.sellPrice*a.qty,0);return l.useEffect(()=>{C(n)},[n]),e.jsxs("div",{className:"p-4 bg-white rounded-lg shadow",children:[e.jsx("h3",{className:"text-lg font-bold mb-2",children:"اختيار المنتجات"}),e.jsx(w,{placeholder:"ابحث عن المنتج بالاسم أو الكود...",value:u,onChange:t=>g(t.target.value),className:"mb-2"}),u&&j.length>0&&e.jsx("div",{className:"max-h-40 overflow-y-auto border p-2 rounded mb-4",children:j.map(t=>e.jsxs("div",{className:"flex justify-between items-center p-1 hover:bg-gray-100 cursor-pointer",onClick:()=>h(t),children:[e.jsxs("span",{children:[t.name," (",t.code,") - $",t.sellPrice," / ",t.warehouse]}),e.jsxs("span",{children:["المخزون: ",t.quantity]})]},t.id))}),o.length>0&&e.jsxs("table",{className:"w-full border-collapse",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"border p-1",children:"المنتج"}),e.jsx("th",{className:"border p-1",children:"الكود"}),e.jsx("th",{className:"border p-1",children:"السعر"}),e.jsx("th",{className:"border p-1",children:"الكمية"}),e.jsx("th",{className:"border p-1",children:"المجموع"}),e.jsx("th",{className:"border p-1",children:"حذف"})]})}),e.jsxs("tbody",{children:[o.map(t=>e.jsxs("tr",{children:[e.jsx("td",{className:"border p-1",children:t.name}),e.jsx("td",{className:"border p-1",children:t.code}),e.jsx("td",{className:"border p-1",children:e.jsx(w,{type:"number",min:0,value:t.sellPrice,onChange:a=>i(t.id,Number(a.target.value)),className:"w-16"})}),e.jsx("td",{className:"border p-1",children:e.jsx(w,{type:"number",min:1,value:t.qty,onChange:a=>p(t.id,Number(a.target.value)),className:"w-16"})}),e.jsxs("td",{className:"border p-1",children:["$",(t.sellPrice*t.qty).toFixed(2)]}),e.jsx("td",{className:"border p-1 text-center",children:e.jsx(N,{variant:"destructive",size:"sm",onClick:()=>S(t.id),children:e.jsx(O,{})})})]},t.id)),e.jsxs("tr",{children:[e.jsx("td",{colSpan:4,className:"border p-1 font-bold text-right",children:"الإجمالي"}),e.jsxs("td",{colSpan:2,className:"border p-1 font-bold",children:["$",n.toFixed(2)]})]})]})]})]})};function pe(){const[b,x]=V.useState(!1),[C,u]=l.useState([]),[g,o]=l.useState(""),[m,j]=l.useState(""),[h,p]=l.useState(0),[i,S]=l.useState([]),[n,t]=l.useState("cash"),[a,r]=l.useState(""),d=J(),[c,q]=l.useState(""),[y,D]=l.useState(1),F=Z({mutationFn:s=>W({newSell:s}),onSuccess:()=>{alert("تم بيع المنتج بنجاح!"),u([]),o(""),j(""),p(0),S([]),t("cash"),r(""),d.invalidateQueries({queryKey:["sells-table"]})},onError:s=>{console.error(s),alert("حدث خطأ أثناء بيع المنتج")}}),k=s=>i.some(f=>JSON.stringify(f)===JSON.stringify(s)),R=s=>{S(f=>k(s)?f.filter(E=>JSON.stringify(E)!==JSON.stringify(s)):[s])},{data:L,isLoading:te}=P({queryKey:["products-table"],queryFn:Q});l.useEffect(()=>{p(Number((Number(m)-Number(g)).toFixed(3)))},[g,m]);const{data:I,isLoading:se}=P({queryKey:["customers-table"],queryFn:G}),A=[{key:"id",label:"الرمز",sortable:!0,hidden:!0},{key:"name",label:"الاسم",sortable:!0},{key:"number",label:"الرقم",sortable:!0}];return e.jsx(K,{children:e.jsxs(M,{children:[e.jsx(T,{children:e.jsx("h1",{className:"text-2xl font-bold",children:"بيع المنتجات"})}),e.jsxs($,{className:"grid grid-cols-1 md:grid-cols-3 gap-2",children:[e.jsx("div",{className:"md:col-span-1",children:e.jsx(B,{title:"الزبائن",titleButton:e.jsx(U,{isOpen:b,setIsOpen:x,className:"w-full mb-2"}),columns:A||[],data:I||[],onRowClick:s=>R(s),getRowClassName:s=>i!=null&&i.some(f=>f===s)?"bg-green-50 hover:bg-green-100":""})}),e.jsx("div",{className:"md:col-span-2",children:e.jsx(ee,{products:L,setAmount:j,onChange:s=>u(s)})}),e.jsxs("form",{className:"md:col-span-3 mt-8 grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsx(v,{label:"الحسم",id:"discount-amount",type:"text",value:g,onChange:s=>o(s.target.value)}),e.jsx(v,{label:"السعر النهائي",id:"discount-amount",type:"text",value:h.toString(),onChange:s=>{}}),e.jsxs("div",{className:"grid grid-cols-3 gap-2 md:col-span-2",children:[e.jsx(N,{onClick:()=>{t("cash")},className:"col-span-1",variant:n==="cash"?"default":"outline",type:"button",children:"نقدا"}),e.jsx(N,{onClick:()=>{t("part")},className:"col-span-1",variant:n==="part"?"default":"outline",type:"button",children:"جزئي"}),e.jsx(N,{onClick:()=>{t("debt")},className:"col-span-1",variant:n==="debt"?"default":"outline",type:"button",children:"دين"})]}),n==="part"&&e.jsx(v,{id:"partPayment",label:"قيمة الدفعة",value:a.toString(),onChange:s=>r(s.target.value)}),n!="debt"&&e.jsxs(e.Fragment,{children:[" ",e.jsxs(z,{value:c,onValueChange:q,children:[e.jsx(H,{className:"w-full mt-6",children:e.jsx(X,{placeholder:"العملة المدفوع بها"})}),e.jsx(Y,{children:["SYP","USD"].map(s=>e.jsx(_,{value:s,children:s},s))})]}),e.jsx(v,{id:"exchangeRate",label:"سعر الصرف",value:c=="USD"?1:y,onChange:s=>D(Number(s.target.value)),disabled:c==="USD"})]}),e.jsx(N,{className:"w-full md:col-span-2",variant:"accent",onClick:s=>{if(s.preventDefault(),i.length<=0){alert("الرجاء التأكد من اختيار زبون");return}F.mutate({customerId:i.length>0?i[0].id:"نقدي",totalPrice:h,products:C,paymentStatus:n==="cash"?"cash":n==="part"?"part":"debt",remainingDebt:n==="cash"?0:n==="part"?h-(c=="USD"?Number(a):Number((Number(a)/y).toFixed(1))):h,currency:c,exchangeRate:y,amount_base:h*y,partValue:Number(a)})},children:"اتمام عملية البيع"})]})]})]})})}export{pe as default};
