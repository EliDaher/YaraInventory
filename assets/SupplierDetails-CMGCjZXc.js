import{l as ae,z as le,r as l,f as re,e as ne,j as e,J as x}from"./index-CjkZiZSH.js";import{C as ie,D as oe,S as ue}from"./Skeleton-eQ6LeI7g.js";import{D as A}from"./DataTable-DMCrox0U.js";import{D as ce}from"./badge-BuRiJ7vp.js";import{P as de}from"./PaymentTypeSelector-y1CAldA5.js";import{B as o}from"./button-BgzGu4Sa.js";import{C as E,b as me}from"./card-BqDxa_jD.js";import{P as f,F as i,S as L,a as Q,b as z,c as B,d as K}from"./FormInput-ZUc2U5_b.js";import{a as pe}from"./supplier-Dt2FfB-h.js";import{a as xe,b as he}from"./transaction-BYWW-0Q4.js";import{u as M}from"./useMutation-2hLPBwUX.js";import{A as ye}from"./arrow-left-BWpzt-6t.js";import{C as J}from"./CardContent-eFVOvZkr.js";import"./customer-Dut-1eV6.js";import"./DefaultPropsProvider-DNL-d3Gt.js";import"./useSlot-jGtp9m50.js";import"./table-BMBfgQsc.js";import"./input-BnqY-c5L.js";import"./search-Bz7BPxDg.js";import"./user-CdSRfBsv.js";import"./house-DPQolJEK.js";function Le(){var O,F,U,T;const Y=ae(),u=le().state,[_,h]=l.useState(!1),[$,S]=l.useState(!1),[d,v]=l.useState(""),[n,y]=l.useState(""),[m,g]=l.useState(""),[N,H]=l.useState("cash"),[C,G]=l.useState(0),[D,W]=l.useState(""),[r,P]=l.useState(""),[c,k]=l.useState(1),[I,j]=l.useState(null),R=re(),[X,q]=l.useState({}),{data:a,isLoading:Z}=ne({queryKey:["supplier-details",u],queryFn:()=>pe(u),enabled:!!u});l.useEffect(()=>{a!=null&&a.data&&q(a.data)},[a]);const w=M({mutationFn:t=>xe(t),onSuccess:()=>{x.success("تم إضافة الدفعة بنجاح!"),y(""),g(""),h(!1),S(!1),R.invalidateQueries({queryKey:["supplier-details"]})},onError:t=>{console.error(t),x.error("حدث خطأ أثناء إضافة الدفعة")}}),b=M({mutationFn:t=>he(t),onSuccess:()=>{x.success("تم الارجاع بنجاح!"),v(""),j(null),R.invalidateQueries({queryKey:["supplier-details"]})},onError:t=>{console.error(t),x.error("حدث خطأ أثناء ارجاع المنتج")}}),ee=[{label:"المعرف",key:"id",hidden:!0},{label:"المبلغ",key:"amount"},{label:"الوصف",key:"note"},{label:"التاريخ",key:"date"}],te=[{label:"المعرف",key:"id",hidden:!0},{label:"كود المادة",key:"code"},{label:"اسم المادة",key:"name"},{label:"الكمية",key:"quantity"},{label:"المستودع",key:"warehouse"},{label:"السعر النهائي",key:"totalPrice"},{label:"التاريخ",key:"date"}],se=async(t,s)=>{var V;t.preventDefault();try{const p={productCode:s.code,supplierId:u.id,warehouse:s.warehouse,qty:-Number(d),returnType:N,returnValue:Number(d)*s.payPrice,referenceId:s.id,productId:s.id,partValue:C,reason:D};b.mutate(p)}catch(p){console.error("❌ خطأ أثناء الإرجاع:",((V=p.response)==null?void 0:V.data)||p.message)}};return e.jsx(ce,{children:e.jsxs("div",{className:"space-y-6",dir:"rtl",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h1",{className:"text-3xl font-bold",children:"بيانات المورد"}),e.jsxs(o,{onClick:()=>Y(-1),variant:"outline",children:[e.jsx(ye,{className:"ml-2 w-4 h-4"})," رجوع"]})]}),e.jsxs(E,{children:[e.jsx(ie,{children:e.jsx(me,{children:"المعلومات الأساسية"})}),e.jsxs(J,{className:"grid grid-cols-1 gap-4",children:[e.jsx(oe,{customer:X,setCustomer:q,isSupplier:!0}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(f,{title:"دفعة من المورد",trigger:e.jsx(o,{className:"w-full",onClick:t=>{h(!0),t.stopPropagation()},variant:"accent",size:"sm",children:"دفعة من المورد"}),isOpen:_,setIsOpen:h,children:e.jsxs("form",{className:"space-y-4 mt-4",onSubmit:t=>{t.preventDefault(),w.mutate({supplierId:u,amount:r=="USD"?n:Number((Number(n)/c).toFixed(1)),note:m,currency:r,exchangeRate:c,amount_base:n})},children:[e.jsx(i,{label:"قيمة الدفعة",id:"payment-amount",type:"text",value:n,onChange:t=>y(t.target.value)}),e.jsx(i,{label:"ملاحظات",id:"note",type:"text",value:m,onChange:t=>g(t.target.value)}),e.jsxs(L,{value:r,onValueChange:P,children:[e.jsx(Q,{className:"w-full mt-6",children:e.jsx(z,{placeholder:"العملة المدفوع بها"})}),e.jsx(B,{children:["SYP","USD"].map(t=>e.jsx(K,{value:t,children:t},t))})]}),e.jsx(i,{id:"exchangeRate",label:"سعر الصرف",value:r=="USD"?1:c,onChange:t=>k(Number(t.target.value)),disabled:r==="USD"}),e.jsx(o,{className:"w-full",type:"submit",children:"دفع للمورد"})]})}),e.jsx(f,{title:"دفع للمورد",trigger:e.jsx(o,{className:"w-full",variant:"destructive",size:"sm",children:"دفع للمورد"}),isOpen:$,setIsOpen:S,children:e.jsxs("form",{className:"space-y-4 mt-4",onSubmit:t=>{t.preventDefault(),w.mutate({supplierId:u,amount:r=="USD"?-n:-Number((Number(n)/c).toFixed(1)),note:m,currency:r,exchangeRate:c,amount_base:-n})},children:[e.jsx(i,{label:"قيمة الدفعة",id:"payment-amount",type:"text",value:n,onChange:t=>y(t.target.value)}),e.jsx(i,{label:"ملاحظات",id:"note",type:"text",value:m,onChange:t=>g(t.target.value)}),e.jsxs(L,{value:r,onValueChange:P,children:[e.jsx(Q,{className:"w-full mt-6",children:e.jsx(z,{placeholder:"العملة المدفوع بها"})}),e.jsx(B,{children:["SYP","USD"].map(t=>e.jsx(K,{value:t,children:t},t))})]}),e.jsx(i,{id:"exchangeRate",label:"سعر الصرف",value:r=="USD"?1:c,onChange:t=>k(Number(t.target.value)),disabled:r==="USD"}),e.jsx(o,{className:"w-full",type:"submit",children:"دفع للمورد"})]})})]})]})]}),e.jsx(E,{className:"overflow-x-auto",children:Z?e.jsx(ue,{className:"h-48 w-full"}):!((F=(O=a==null?void 0:a.data)==null?void 0:O.payments)!=null&&F.length)&&!((T=(U=a==null?void 0:a.data)==null?void 0:U.purchases)!=null&&T.length)?e.jsx("p",{className:"text-muted-foreground text-center",children:"لا توجد معاملات حالياً."}):e.jsxs(J,{className:"space-y-4 md:space-y-0 grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(A,{title:"الدفعات",columns:ee,data:a.data.payments,getRowClassName:t=>t.type!=="income"?"text-red-500":"text-green-500"}),e.jsx(A,{title:"عمليات الشراء",columns:te,data:a.data.purchases,renderRowActions:t=>e.jsx(f,{title:`إرجاع منتج: ${t.code} - ${t.name||""}`,isOpen:I===t.id.toString(),setIsOpen:()=>j(null),trigger:e.jsx(o,{onClick:s=>{s.preventDefault(),s.stopPropagation(),j(t.id.toString()),console.log("row id:",I)},children:"إرجاع"}),children:e.jsxs("form",{onSubmit:s=>se(s,t),className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(i,{label:"الكمية",id:"return-quantity",type:"number",value:d,onChange:s=>v(s.target.value)}),e.jsxs("p",{className:"text-sm text-gray-500",children:["الكمية الأصلية: ",t.quantity,e.jsx("br",{}),"سعر الواحدة: ",t.payPrice]})]}),e.jsxs("p",{className:"font-semibold",children:["المبلغ الإجمالي: ",t.payPrice*Number(d)]}),e.jsx(de,{value:N,onChange:H,partValue:C,onPartValueChange:s=>G(s)}),e.jsx(i,{id:"return-reason",label:"ملاحظات",type:"text",value:D,onChange:s=>W(s.target.value)}),e.jsx("div",{className:"flex justify-end mt-2",children:e.jsx(o,{type:"submit",className:"w-full",disabled:b.isPending,children:b.isPending?"جاري التأكيد...":"تأكيد الإرجاع"})})]})})})]})})]})})}export{Le as default};
