import{i as te,z as ae,r,f as se,u as re,j as e}from"./index-BWmFOvvk.js";import{D as T}from"./DataTable-CY1TwsKE.js";import{u as V,D as le}from"./badge-CVDZ5wrw.js";import{P as ne}from"./PaymentTypeSelector-D-VY1_K4.js";import{B as o}from"./button-DkKObyqW.js";import{C as A,b as ie}from"./card-Bl_vHJgX.js";import{P as j,F as i,S as E,a as L,b as B,c as Q,d as z}from"./FormInput-BFWnl-Us.js";import{a as oe}from"./supplier-D4PlD4NE.js";import{a as ue,b as ce}from"./transaction-Ban7EQLG.js";import{A as de}from"./arrow-left-R9Nv8seB.js";import{C as me,S as pe}from"./Skeleton-BOo1yelm.js";import{C as K}from"./CardContent-CAAp7e1g.js";import"./table-Daob2WTk.js";import"./input-CjNjdnkP.js";import"./search-D7Hrmcgv.js";import"./house-C0NkjXA-.js";import"./DefaultPropsProvider-CYGlFfv5.js";import"./useSlot-BTc3yXxA.js";function Ue(){var O,k,q,F;const M=te(),u=ae().state,[Y,x]=r.useState(!1),[_,f]=r.useState(!1),[d,S]=r.useState(""),[n,h]=r.useState(""),[m,b]=r.useState(""),[v,$]=r.useState("cash"),[N,G]=r.useState(0),[C,H]=r.useState(""),[l,D]=r.useState(""),[c,P]=r.useState(1),[w,g]=r.useState(null),I=se(),[he,J]=r.useState({}),{data:s,isLoading:W}=re({queryKey:["supplier-details",u],queryFn:()=>oe(u),enabled:!!u});r.useEffect(()=>{s&&J(s)},[s]);const R=V({mutationFn:t=>ue(t),onSuccess:()=>{alert("تم إضافة الدفعة بنجاح!"),h(""),b(""),x(!1),f(!1),I.invalidateQueries({queryKey:["supplier-details"]})},onError:t=>{console.error(t),alert("حدث خطأ أثناء إضافة المنتج")}}),y=V({mutationFn:t=>ce(t),onSuccess:()=>{alert("تم الارجاع بنجاح!"),S(""),g(null),I.invalidateQueries({queryKey:["supplier-details"]})},onError:t=>{console.error(t),alert("حدث خطأ أثناء ارجاع المنتج")}}),X=[{label:"المعرف",key:"id",hidden:!0},{label:"المبلغ",key:"amount"},{label:"الوصف",key:"note"},{label:"التاريخ",key:"date"}],Z=[{label:"المعرف",key:"id",hidden:!0},{label:"كود المادة",key:"code"},{label:"اسم المادة",key:"name"},{label:"الكمية",key:"quantity"},{label:"المستودع",key:"warehouse"},{label:"السعر النهائي",key:"totalPrice"},{label:"التاريخ",key:"date"}],ee=async(t,a)=>{var U;t.preventDefault();try{const p={productCode:a.code,supplierId:u.id,warehouse:a.warehouse,qty:-Number(d),returnType:v,returnValue:Number(d)*a.payPrice,referenceId:a.id,productId:a.id,partValue:N,reason:C};y.mutate(p)}catch(p){console.error("❌ خطأ أثناء الإرجاع:",((U=p.response)==null?void 0:U.data)||p.message)}};return e.jsx(le,{children:e.jsxs("div",{className:"space-y-6",dir:"rtl",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h1",{className:"text-3xl font-bold",children:"بيانات المورد"}),e.jsxs(o,{onClick:()=>M(-1),variant:"outline",children:[e.jsx(de,{className:"ml-2 w-4 h-4"})," رجوع"]})]}),e.jsxs(A,{children:[e.jsx(me,{children:e.jsx(ie,{children:"المعلومات الأساسية"})}),e.jsxs(K,{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[s&&Object.entries(s.data).map(([t,a])=>t==="payments"||t==="purchases"||t==="id"?null:e.jsxs("p",{className:"flex gap-2 relative group mb-4 items-end",children:[e.jsxs("label",{className:"block font-bold w-36",children:[t,":"]}),t.includes("date")&&new Date(a).toString()!=="Invalid Date"?e.jsx("input",{type:"text",value:new Date(a).toLocaleString("en-GB"),readOnly:!0,className:"bg-transparent border-b-2 border-transparent focus:border-primary-500 outline-none transition-all w-full"}):e.jsx("input",{type:"text",value:a,readOnly:!0,className:"bg-transparent border-b-2 border-transparent focus:border-primary-500 outline-none transition-all w-full"}),e.jsx("span",{className:"absolute bottom-0 right-0 w-full h-[2px] bg-primary-500 scale-x-0 group-hover:scale-x-100 origin-right transition-transform duration-300"})]},t)),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(j,{title:"دفعة من المورد",trigger:e.jsx(o,{className:"w-full",onClick:t=>{x(!0),t.stopPropagation()},variant:"accent",size:"sm",children:"دفعة من المورد"}),isOpen:Y,setIsOpen:x,children:e.jsxs("form",{className:"space-y-4 mt-4",onSubmit:t=>{t.preventDefault(),R.mutate({supplierId:u,amount:l=="USD"?n:Number((Number(n)/c).toFixed(1)),note:m,currency:l,exchangeRate:c,amount_base:n})},children:[e.jsx(i,{label:"قيمة الدفعة",id:"payment-amount",type:"text",value:n,onChange:t=>h(t.target.value)}),e.jsx(i,{label:"ملاحظات",id:"note",type:"text",value:m,onChange:t=>b(t.target.value)}),e.jsxs(E,{value:l,onValueChange:D,children:[e.jsx(L,{className:"w-full mt-6",children:e.jsx(B,{placeholder:"العملة المدفوع بها"})}),e.jsx(Q,{children:["SYP","USD"].map(t=>e.jsx(z,{value:t,children:t},t))})]}),e.jsx(i,{id:"exchangeRate",label:"سعر الصرف",value:l=="USD"?1:c,onChange:t=>P(Number(t.target.value)),disabled:l==="USD"}),e.jsx(o,{className:"w-full",type:"submit",children:"دفع للمورد"})]})}),e.jsx(j,{title:"دفع للمورد",trigger:e.jsx(o,{className:"w-full",variant:"destructive",size:"sm",children:"دفع للمورد"}),isOpen:_,setIsOpen:f,children:e.jsxs("form",{className:"space-y-4 mt-4",onSubmit:t=>{t.preventDefault(),R.mutate({supplierId:u,amount:l=="USD"?-n:-Number((Number(n)/c).toFixed(1)),note:m,currency:l,exchangeRate:c,amount_base:-n})},children:[e.jsx(i,{label:"قيمة الدفعة",id:"payment-amount",type:"text",value:n,onChange:t=>h(t.target.value)}),e.jsx(i,{label:"ملاحظات",id:"note",type:"text",value:m,onChange:t=>b(t.target.value)}),e.jsxs(E,{value:l,onValueChange:D,children:[e.jsx(L,{className:"w-full mt-6",children:e.jsx(B,{placeholder:"العملة المدفوع بها"})}),e.jsx(Q,{children:["SYP","USD"].map(t=>e.jsx(z,{value:t,children:t},t))})]}),e.jsx(i,{id:"exchangeRate",label:"سعر الصرف",value:l=="USD"?1:c,onChange:t=>P(Number(t.target.value)),disabled:l==="USD"}),e.jsx(o,{className:"w-full",type:"submit",children:"دفع للمورد"})]})})]})]})]}),e.jsx(A,{className:"overflow-x-auto",children:W?e.jsx(pe,{className:"h-48 w-full"}):!((k=(O=s==null?void 0:s.data)==null?void 0:O.payments)!=null&&k.length)&&!((F=(q=s==null?void 0:s.data)==null?void 0:q.purchases)!=null&&F.length)?e.jsx("p",{className:"text-muted-foreground text-center",children:"لا توجد معاملات حالياً."}):e.jsxs(K,{className:"space-y-4 md:space-y-0 grid md:grid-cols-2 gap-4",children:[e.jsx(T,{title:"الدفعات",columns:X,data:s.data.payments,getRowClassName:t=>t.type!=="income"?"text-red-500":"text-green-500"}),e.jsx(T,{title:"عمليات الشراء",columns:Z,data:s.data.purchases,renderRowActions:t=>e.jsx(j,{title:`إرجاع منتج: ${t.code} - ${t.name||""}`,isOpen:w===t.id.toString(),setIsOpen:()=>g(null),trigger:e.jsx(o,{onClick:a=>{a.preventDefault(),a.stopPropagation(),g(t.id.toString()),console.log("row id:",w)},children:"إرجاع"}),children:e.jsxs("form",{onSubmit:a=>ee(a,t),className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(i,{label:"الكمية",id:"return-quantity",type:"number",value:d,onChange:a=>S(a.target.value)}),e.jsxs("p",{className:"text-sm text-gray-500",children:["الكمية الأصلية: ",t.quantity,e.jsx("br",{}),"سعر الواحدة: ",t.payPrice]})]}),e.jsxs("p",{className:"font-semibold",children:["المبلغ الإجمالي: ",t.payPrice*Number(d)]}),e.jsx(ne,{value:v,onChange:$,partValue:N,onPartValueChange:a=>G(a)}),e.jsx(i,{id:"return-reason",label:"ملاحظات",type:"text",value:C,onChange:a=>H(a.target.value)}),e.jsx("div",{className:"flex justify-end mt-2",children:e.jsx(o,{type:"submit",className:"w-full",disabled:y.isPending,children:y.isPending?"جاري التأكيد...":"تأكيد الإرجاع"})})]})})})]})})]})})}export{Ue as default};
